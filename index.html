<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hello, girl" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="just do it.">
<meta property="og:type" content="website">
<meta property="og:title" content="Duan">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Duan">
<meta property="og:description" content="just do it.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Duan">
<meta name="twitter:description" content="just do it.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Duan</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Duan</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">The more hard, the more fortunate.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/16/Android-的消息机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="James Duan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Duan">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/16/Android-的消息机制/" itemprop="url">Android 的消息机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-16T19:29:29+08:00">
                2017-05-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Android-Android-的消息机制"><a href="#Android-Android-的消息机制" class="headerlink" title="Android-Android 的消息机制"></a>Android-Android 的消息机制</h3><blockquote>
<p>Android 的消息机制主要指的是 Handler 的运行机制，Handler 是 Android 消息机制的上层接口，通过 Handler 可以轻松的将一个任务切换到 Handler 所在的线程中去执行，由于 Android 开发规范的限制，我们不能在非 UI 线程中更新 UI，同时不应该也不能在 UI 线程中进行耗时的 I/O 操作或者进行网络访问，这时就需要使用 Handler。</p>
</blockquote>
<h4 id="1-Handler、MessageQueue、Looper-概述"><a href="#1-Handler、MessageQueue、Looper-概述" class="headerlink" title="1 Handler、MessageQueue、Looper 概述"></a>1 Handler、MessageQueue、Looper 概述</h4><blockquote>
<p>Handler 的运行需要底层的 MessageQueue 和 Looper 的支撑。</p>
</blockquote>
<ul>
<li>MessageQueue：其中文翻译是“消息队列”，内部存储了一组消息（Message），虽然叫消息队列，但其内部使用的数据结构并不是队列，而是单链表。</li>
<li>Looper：Looper 会以无限循环的方式去 MessageQueue 中查找是否还有未处理的消息或新消息，有的话就处理，没有则等待。</li>
<li>ThreadLocal：Looper 中使用到了 ThreadLocal ，ThreadLocal 并不是线程，我们知道 Handler 创建时会采用当前线程的 Looper 来构造消息循环系统，那他怎么找到当前线程的 Looper 实例呢？ThreadLocal 可以在每个线程中存储同一个对象的不同副本，即不同线程可以调用同一个 ThreadLocal 实例的方法获取属于自己的 Looper 实例，</li>
</ul>
<h4 id="2-Android-消息机制概述"><a href="#2-Android-消息机制概述" class="headerlink" title="2 Android 消息机制概述"></a>2 Android 消息机制概述</h4><h5 id="2-1-ViewRootImpl"><a href="#2-1-ViewRootImpl" class="headerlink" title="2.1 ViewRootImpl"></a>2.1 ViewRootImpl</h5><blockquote>
<p>ViewRootImpl 是链接 WindowManager 和DecorView 的纽带，另外 View 的绘制也是通过ViewRootImpl 来完成的。</p>
</blockquote>
<p>它的主要作用总结如下：</p>
<ul>
<li>链接WindowManager和DecorView的纽带，更广一点可以说是Window和View之间的纽带。</li>
<li>完成View的绘制过程，包括measure、layout、draw过程。</li>
<li>向DecorView分发收到的用户发起的event事件，如按键，触屏等事件。</li>
</ul>
<p>ViewRootImpl 是View 树的树根，但它不是View，它实现了 View 与 WindowManager 之间的通信协议，<br>参考链接：<a href="http://www.2cto.com/kf/201606/519988.html" target="_blank" rel="external">Android中的ViewRootImpl类源码解析</a></p>
<h5 id="2-2-系统怎么知道你在哪里更新的-UI"><a href="#2-2-系统怎么知道你在哪里更新的-UI" class="headerlink" title="2.2 系统怎么知道你在哪里更新的 UI"></a>2.2 系统怎么知道你在哪里更新的 UI</h5><p>Android 规定开发着不能在非 UI 线程中更新 UI，如果你不遵守这个规定，那么将引发运行时异常<code>CalledFromWrongThreadException</code>，其原因在于 ViewRootImpl 对 UI 操作做了验证， ViewRootImpl 作为视图层次结构的顶部，对 UI 的访问操作大部分都会传递到 ViewRootImpl  中，ViewRootImpl 会在 checkThread 方法中检查访问操作是否在 UI 线程，不是的话就会抛出异常。</p>
<p></p><h5><center>ViewRootImpl # checkThread() </center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkThread</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (mThread != Thread.currentThread()) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> CalledFromWrongThreadException(</div><div class="line">                 <span class="string">"Only the original thread that created a view hierarchy can touch its views."</span>);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h5 id="2-3-系统为什么不允许在-UI-线程中访问-UI-呢？"><a href="#2-3-系统为什么不允许在-UI-线程中访问-UI-呢？" class="headerlink" title="2.3 系统为什么不允许在 UI 线程中访问 UI 呢？"></a>2.3 系统为什么不允许在 UI 线程中访问 UI 呢？</h5><blockquote>
<p>这是因为 Android 的 UI 控件不是线程安全的，如果在多线程中并发访问可能会导致 UI 控件处于不可预期的状态，那为什么不对 UI 控件的访问加上锁呢？缺点有两个：首先加上锁机制会让 UI 访问的逻辑变得复杂；其次锁机制会降低 UI 访问的效率，因为锁机制会阻塞某些线程的执行。</p>
</blockquote>
<h4 id="3-ThreadLocal-的工作原理"><a href="#3-ThreadLocal-的工作原理" class="headerlink" title="3 ThreadLocal 的工作原理"></a>3 ThreadLocal 的工作原理</h4><blockquote>
<p><u><b>java.lang.ThreadLocal</b></u></p>
<p>该类提供了线程局部 (thread-local) 变量。这些变量不同于它们的普通对应物，因为访问某个变量（通过其 get 或 set 方法）的每个线程都有自己的局部变量，它独立于变量的初始化副本。ThreadLocal 实例通常是类中的 private static 字段，它们希望将状态与某一个线程（例如，用户 ID 或事务 ID）相关联。 </p>
<p>ThreadLocal 是一个线程内部的数据存储类，通过它可以在指定的线程中存储数据，数据存储后，只有在指定线程中可以获取到数据，对于其他线程来说则无法获取到数据。</p>
</blockquote>
<p>举个栗子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">    ThreadLocal&lt;Integer&gt; mLocal = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">        Main test = <span class="keyword">new</span> Main ();</div><div class="line">		test.mLocal.set(<span class="number">30</span>);</div><div class="line">        test.print(<span class="string">"thread: "</span> + Thread.currentThread().getName() + <span class="string">" "</span> + test.mLocal.get());</div><div class="line">        test.test();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String string)</span> </span>&#123;</div><div class="line">        System.out.println(string);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">        </div><div class="line">        <span class="keyword">new</span> Thread(<span class="string">"Thread#1"</span>) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                mLocal.set(<span class="number">31</span>);</div><div class="line">                print(<span class="string">"thread: "</span> + <span class="keyword">this</span>.getName() + <span class="string">" "</span> + mLocal.get());</div><div class="line">            &#125;</div><div class="line">        &#125;.start();</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">new</span> Thread(<span class="string">"Thread#2"</span>) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                mLocal.set(<span class="number">32</span>);</div><div class="line">                print(<span class="string">"thread: "</span> + <span class="keyword">this</span>.getName() + <span class="string">" "</span> + mLocal.get());</div><div class="line">            &#125;</div><div class="line">        &#125;.start();</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">new</span> Thread(<span class="string">"Thread#3"</span>) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                mLocal.set(<span class="number">32</span>);</div><div class="line">                print(<span class="string">"thread: "</span> + <span class="keyword">this</span>.getName() + <span class="string">" "</span> + mLocal.get());</div><div class="line">            &#125;</div><div class="line">        &#125;.start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的例子在执行 test 方法时，启动了三个线程，在这三个线程中分别修改了 mLocal 的值，当各自线程通过调用 ThreadLocal 的 get 方法取值时取到的值是不同的，即各个线程有属于自己的一个值。</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function">F:\<span class="title">javaStuff</span>&gt;<span class="title">javac</span> <span class="title">Main.java</span></span></div><div class="line"><span class="title">F</span>:\<span class="title">javaStuff</span>&gt;<span class="title">java</span> <span class="title">Main</span></div><div class="line"><span class="title">thread</span>: <span class="title">main</span> 30</div><div class="line"><span class="title">thread</span>: <span class="title">Thread</span>#1 31</div><div class="line"><span class="title">thread</span>: <span class="title">Thread</span>#2 32</div><div class="line"><span class="title">thread</span>: <span class="title">Thread</span>#3 32</div></pre></td></tr></table></figure>
<blockquote>
<p>ThreadLocal 之所以有这么奇妙的功能，是因为不同线程访问同一个 ThreadLocal 对象的 get 方法，ThreadLocal 内部会从各自的线程中取出一个数据实体，然后再从数据实体中取得对应的 value 值。</p>
</blockquote>
<p>那这个线程私有的数据实体在哪呢？<br>先看看 ThreadLocal 的 get 方法</p>
<p></p><h5><center>JDK 1.8.0_45  ThreadLocal # get () </center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        Thread t = Thread.currentThread();</div><div class="line">        ThreadLocalMap map = getMap(t);</div><div class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">            ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</div><div class="line">            <span class="keyword">if</span> (e != <span class="keyword">null</span>)</div><div class="line">                <span class="keyword">return</span> (T)e.value;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> setInitialValue();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到这里使用了 ThreadLocalMap.Entry 来保存数据，在《Android 开发艺术探索》一书中说的是使用 ThreadLocal.Values 来保存数据，这里的不同应该是由于 JDK 版本升级过程导致的。<br>再看看在 Thread 中 对 ThreadLocalMap 的引用：</p>
<p></p><h5><center>Thread # threadLocals </center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* ThreadLocal values pertaining to this thread. This map is maintained</span></div><div class="line">     * by the ThreadLocal class. */</div><div class="line">    ThreadLocal.ThreadLocalMap threadLocals = <span class="keyword">null</span>;</div></pre></td></tr></table></figure>
<p>从 ThreadLocal 的 get方法可以知道<code>getMap(t)</code>操作会得到当前线程的 threadLocals 对象，看看 getMap 方法。</p>
<p></p><h5><center>ThreadLocal # getMap(Thread t)</center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> t.threadLocals;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>到这里就很清晰了，getMap 方法会返回当前线程的 threadLocals  。</p>
<h5 id="3-1-ThreadLocal-使用场景"><a href="#3-1-ThreadLocal-使用场景" class="headerlink" title="3.1 ThreadLocal 使用场景"></a>3.1 ThreadLocal 使用场景</h5><ul>
<li>当某些数据是以线程作为作用域并且不同线程具有不同的数据副本。</li>
<li>复杂逻辑下的数据传递，比如监听器的传递，有些时候一个线程中的任务过于复杂，这可能表现为函数调用栈比较深以及代码入口的多样性，在这种情况下我们又需要监听器贯穿整个线程的执行过程，这个时候该怎么办？这个时候就可以采用 ThreadLocal ，采用 ThreadLocal 可以让监听器作为线程内的全局对象，在线程内部只需调用 ThreadLocal 的 get 方法就能获得监听器。</li>
</ul>
<h4 id="4-MessageQueue-的工作原理"><a href="#4-MessageQueue-的工作原理" class="headerlink" title="4 MessageQueue 的工作原理"></a>4 MessageQueue 的工作原理</h4><p>一个 Handler 可以正常工作的线程只会有一个 MessageQueue 的实例。<br>MessageQueue 主要包含两个操作：</p>
<ul>
<li>插入：enqueueMessage</li>
<li>删除（读取）：next</li>
</ul>
<h5 id="4-1-enqueueMessage-方法"><a href="#4-1-enqueueMessage-方法" class="headerlink" title="4.1 enqueueMessage 方法"></a>4.1 enqueueMessage 方法</h5><p></p><h5><center>MessageQueue # enqueueMessage(Message msg, long when) </center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(Message msg, <span class="keyword">long</span> when)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        ...</div><div class="line">        msg.markInUse();</div><div class="line">        msg.when = when;</div><div class="line">        Message p = mMessages;</div><div class="line">        <span class="keyword">boolean</span> needWake;</div><div class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span> || when == <span class="number">0</span> || when &lt; p.when) &#123;</div><div class="line">            <span class="comment">// New head, wake up the event queue if blocked.</span></div><div class="line">            msg.next = p;</div><div class="line">            mMessages = msg;</div><div class="line">            needWake = mBlocked;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ...</div><div class="line">            Message prev;</div><div class="line">            <span class="keyword">for</span> (;;) &#123;</div><div class="line">                prev = p;</div><div class="line">                p = p.next;</div><div class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span> || when &lt; p.when) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</div><div class="line">                    needWake = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            msg.next = p; <span class="comment">// invariant: p == prev.next</span></div><div class="line">            prev.next = msg;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>if (p == null || when == 0 || when &lt; p.when) {..</code>： 其中 p 为下一个待处理的消息，如果 p 为 null，或插入消息的执行时间为“立刻”(when  == 0)，或插入消息执行时间比下一个待处理消息早，那么插入消息就做为新的消息队列头，将其插入对头（<code>msg.next = p; mMessages = msg;</code>）。<br>若该判断不满足，即当前消息队列不为空，插入消息的执行时间不是“立刻”，则将其插入队列（按执行时间排序）。</p>
<h5 id="4-1-next-方法"><a href="#4-1-next-方法" class="headerlink" title="4.1 next 方法"></a>4.1 next 方法</h5><p></p><h5><center>MessageQueue # next() </center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">for</span> (;;) &#123;</div><div class="line">            <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</div><div class="line">                Binder.flushPendingCommands();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            nativePollOnce(ptr, nextPollTimeoutMillis);</div><div class="line"></div><div class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                <span class="comment">// Try to retrieve the next message.  Return if found.</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</div><div class="line">                Message prevMsg = <span class="keyword">null</span>;</div><div class="line">                Message msg = mMessages;</div><div class="line">                <span class="keyword">if</span> (msg != <span class="keyword">null</span> &amp;&amp; msg.target == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span></div><div class="line">                    <span class="keyword">do</span> &#123;</div><div class="line">                        prevMsg = msg;</div><div class="line">                        msg = msg.next;</div><div class="line">                    &#125; <span class="keyword">while</span> (msg != <span class="keyword">null</span> &amp;&amp; !msg.isAsynchronous());</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (now &lt; msg.when) &#123;</div><div class="line">                        <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></div><div class="line">                        nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="comment">// Got a message.</span></div><div class="line">                        mBlocked = <span class="keyword">false</span>;</div><div class="line">                        <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</div><div class="line">                            prevMsg.next = msg.next;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            mMessages = msg.next;</div><div class="line">                        &#125;</div><div class="line">                        msg.next = <span class="keyword">null</span>;</div><div class="line">                        <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Returning message: "</span> + msg);</div><div class="line">                        msg.markInUse();</div><div class="line">                        <span class="keyword">return</span> msg;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// No more messages.</span></div><div class="line">                    nextPollTimeoutMillis = -<span class="number">1</span>;</div><div class="line">                &#125;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">		...</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>可以发现 next 方法是一个无限循环方法，如果消息队列中没有消息，那么 next 方法会一直阻塞。当有新的消息到来时，next 方法会返回这条消息并将其从单链表中移除。</p>
</blockquote>
<p>MessageQueue 的 next 方法会被 Looper 的 loop 方法调用，从而使 loop 方法也成为阻塞方法。</p>
<h4 id="4-Looper-的工作原理"><a href="#4-Looper-的工作原理" class="headerlink" title="4 Looper 的工作原理"></a>4 Looper 的工作原理</h4><p>一个 Handler 可以正常工作的线程只会有一个 Looper 的实例。</p>
<blockquote>
<p>Looper 在 Android 的消息机制中扮演者消息循环的角色，具体来说就是它会不断的从 MessageQueue 中查看是否有新消息，如果有新消息就立刻处理，否则就一直阻塞在那里。</p>
</blockquote>
<p>先看看 Looper 的构造方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">       mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed);</div><div class="line">       mThread = Thread.currentThread();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到 Looper 的构造方法是私有的，即外界无法通过 new 关键字创建其实例。<br>构造方法会实例化 MessageQueue 的实例 <code>mQueue</code>。</p>
<h5 id="4-1-在非-UI-线程使用-Handler"><a href="#4-1-在非-UI-线程使用-Handler" class="headerlink" title="4.1 在非 UI 线程使用 Handler"></a>4.1 在非 UI 线程使用 Handler</h5><ul>
<li><p>如果想在一个子线程（非 UI 线程）中正常的使用 Handler ，就必须让当前线程拥有一个 Looper（Looper.prepare()），并且执行其 loop （Looper.loop()）方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Handler mHandler;</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">new</span> Thread() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">               mHandler = <span class="keyword">new</span> Handler();</div><div class="line">               Looper.prepare();</div><div class="line">               Looper.loop();</div><div class="line">           &#125;</div><div class="line">       &#125;.start();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>看看 Looper.prepare() 方法<br></p><h5><center>Looper # prepare() </center><p></p>
</h5></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">()</span> </span>&#123;</div><div class="line">       prepare(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</div><div class="line">      <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</div><div class="line">      &#125;</div><div class="line">      sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p><code>sThreadLocal.get()</code> 返回结果不为空表示当前线程的 Looper.prepare() 方法已经被调用过，即当前线程已存在 Looper 实例。这就可以保证一个线程只有一个Looper，同时也保证了一个线程只有一个 MessageQueue （参照 Looper 构造方法可知）。<br>这里有个关键的变量 <code>sThreadLocal</code>，看看它的声明：</p>
<p></p><h5><center>Looper # sThreadLocal  </center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// sThreadLocal.get() will return null unless you've called prepare().</span></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Looper&gt; sThreadLocal = <span class="keyword">new</span> ThreadLocal&lt;Looper&gt;();</div></pre></td></tr></table></figure>
<p>参照上面对 ThreadLocal 的说明就可以知道 <code>sThreadLocal.get()</code>返回的是当前线程对应的那个 Looper 对象。 </p>
<ul>
<li>Looper.loop() 方法</li>
</ul>
<blockquote>
<p>Looper 最重要的一个方法是 loop 方法，只有调用了 loop 后，消息循环系统才会正真的起作用。</p>
</blockquote>
<p> </p><h5><center>Looper # loop() </center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> Looper me = myLooper();</div><div class="line">       <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">final</span> MessageQueue queue = me.mQueue;</div><div class="line"></div><div class="line">       <span class="comment">// Make sure the identity of this thread is that of the local process,</span></div><div class="line">       <span class="comment">// and keep track of what that identity token actually is.</span></div><div class="line">       Binder.clearCallingIdentity();</div><div class="line">       <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">       <span class="keyword">for</span> (;;) &#123;</div><div class="line">           Message msg = queue.next(); <span class="comment">// might block</span></div><div class="line">           <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="comment">// No message indicates that the message queue is quitting.</span></div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// This must be in a local variable, in case a UI event sets the logger</span></div><div class="line">           <span class="keyword">final</span> Printer logging = me.mLogging;</div><div class="line">           <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">               logging.println(<span class="string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="string">" "</span> +</div><div class="line">                       msg.callback + <span class="string">": "</span> + msg.what);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">final</span> <span class="keyword">long</span> traceTag = me.mTraceTag;</div><div class="line">           <span class="keyword">if</span> (traceTag != <span class="number">0</span> &amp;&amp; Trace.isTagEnabled(traceTag)) &#123;</div><div class="line">               Trace.traceBegin(traceTag, msg.target.getTraceName(msg));</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               msg.target.dispatchMessage(msg);</div><div class="line">           &#125; <span class="keyword">finally</span> &#123;</div><div class="line">               <span class="keyword">if</span> (traceTag != <span class="number">0</span>) &#123;</div><div class="line">                   Trace.traceEnd(traceTag);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (logging != <span class="keyword">null</span>) &#123;</div><div class="line">               logging.println(<span class="string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="string">" "</span> + msg.callback);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// Make sure that during the course of dispatching the</span></div><div class="line">           <span class="comment">// identity of the thread wasn't corrupted.</span></div><div class="line">           <span class="keyword">final</span> <span class="keyword">long</span> newIdent = Binder.clearCallingIdentity();</div><div class="line">           <span class="keyword">if</span> (ident != newIdent) &#123;</div><div class="line">               Log.wtf(TAG, <span class="string">"Thread identity changed from 0x"</span></div><div class="line">                       + Long.toHexString(ident) + <span class="string">" to 0x"</span></div><div class="line">                       + Long.toHexString(newIdent) + <span class="string">" while dispatching to "</span></div><div class="line">                       + msg.target.getClass().getName() + <span class="string">" "</span></div><div class="line">                       + msg.callback + <span class="string">" what="</span> + msg.what);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           msg.recycleUnchecked();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>myLooper()</code>：方法可以获得当前线程的 Looper，该方法是 public 的，在类外也可以调用。</li>
<li><code>Message msg = queue.next(); // might block</code>：next 方法在上面分析<em>MessageQueue 的工作原理</em>时已经分析过了，会next 方法是一个无限循环方法，如果消息队列中没有消息，那么 next 方法会一直阻塞。当有新的消息到来时，next 方法会返回这条消息并将其从单链表中移除。如果 next 方法返回 null，那么 loop 循环就会结束，</li>
<li><code>msg.target.dispatchMessage(msg);</code>：当 next 有消息返回时，Looper 就会处理这条消息，这里的 msg.target 时发送这条消息的 Handler 对象，这样 Handler 发送的消息最终又交给它的 dispatchMessage 方法来处理了。这里要注意的是，dispatchMessage 方法会是在创建 Handler 的线程中执行的，这样就成功的将代码逻辑切换到指定的线程中去执行。（dispatchMessage  方法将在 <u>Handler 的工作原理</u> 中分析）</li>
</ul>
<h5 id="4-2-主线程（ActivityThread-）的消息循环"><a href="#4-2-主线程（ActivityThread-）的消息循环" class="headerlink" title="4.2 主线程（ActivityThread ）的消息循环"></a>4.2 主线程（ActivityThread ）的消息循环</h5><p>Android 的主线程由 ActivityThread 类表示。</p>
<blockquote>
<p>Looper 除了 prepare 方法外，还提供了 prepareMainLooper 方法，这个方法主要是给主线程也就是 ActivityThread 创建 Looper 使用的，其本质也是通过 prepare 方法来实现的。</p>
<p>Java 程序少不了会有一个执行入口 main 方法，那 Android 程序的 main方法在哪呢？<br>其实 Android 的 main 方法被包装在 ActivityThread 类中。所有的 Android 程序都有且仅有一个ActivityThread 类的实例，ActivityThread 所在的线程即为主线程（UI 线程）。</p>
</blockquote>
<p>Android 程序 从ActivityThread 的 main 方法开始执行，调用 prepareMain 方法为主线程创建一个 Looper 和 一个 MessageQueue，然后创建一个 ActivityThread 对象，在 ActivityThread 的初始化代码中会创建一个 Handler 对象。接着 main 方法会调用 Looper.loop() 方法进入消息循环，不断地从消息队列中读取并处理消息。</p>
<p>参考链接：<br><a href="http://blog.csdn.net/lfdfhl/article/details/51279160" target="_blank" rel="external"> Android中线程那些事</a><br><a href="http://www.jianshu.com/p/0efc71f349c8" target="_blank" rel="external">ActivityThread的main方法究竟做了什么？</a></p>
<p></p><h5><center>ActivityThread  # main(String[] args)</center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">     ...</div><div class="line">     Looper.prepareMainLooper();</div><div class="line"></div><div class="line">     ActivityThread thread = <span class="keyword">new</span> ActivityThread();</div><div class="line">     thread.attach(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</div><div class="line">         sMainThreadHandler = thread.getHandler();</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">         Looper.myLooper().setMessageLogging(<span class="keyword">new</span></div><div class="line">                 LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// End of event ActivityThreadMain.</span></div><div class="line">     Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</div><div class="line">     Looper.loop();</div><div class="line"></div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>这里就产生了一个挺有趣的问题：<u><b>ActivityThread 的 main 方法会在 loop 方法处不断循环，没有要处理的消息就会<strong>阻塞</strong>，那为什么这里的阻塞不会引发 ANR（Application Not Responding） 呢？</b></u></p>
<p>想象这样一种情况，如果不执行 loop 方法，那么 Android 程序的主线程一运行完程序就会退出！即用户才打开 APP ，APP 就自己关了，这显然是不可以的。<br>那 Android 是怎么实现阻塞而不引发 ANR 呢？</p>
<p>这里需要先了解 ANR 的产生原因：</p>
<ul>
<li>当前的事件没有机会得到处理（即主线程正在处理前一个事件，前一个事件没有及时的完成或者 looper 被某种原因阻塞住了）</li>
<li>当前的事件正在处理，但没能在规定时间内完成（广播事件处理的 10s 限定，输入事件分发 5s ，前台服务 20s 等）</li>
</ul>
<p>由 ANR 产生的原因可以知道一个关键的因素是 —— <strong>没有及时完成</strong>，即在规定时间内没有完成，而主线程 loop 循环这个操作系统并没有对其有时间限定，而 loop 循环内部在处理消息时，对某个具体消息的执行有时是有时间限定的，超过了这个时间就会引发 ANR。</p>
<h5 id="4-3-Looper-的退出方式"><a href="#4-3-Looper-的退出方式" class="headerlink" title="4.3 Looper 的退出方式"></a>4.3 Looper 的退出方式</h5><blockquote>
<p>Looper 也是可以退出的，Looper 提供了 quit 和 quitSafely 来退出一个 Looper</p>
</blockquote>
<ul>
<li>quit 和 quitSafely 方法<br>这两个方法的区别在于： quit 方法会直接退出 Looper，而 quitSafely 只是设定一个退出标记，然后把消息队列中的已有消息处理完成后才安全退出。<br><h5><center>Looper # quit() &amp; quitSafely()</center></h5></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quit</span><span class="params">()</span> </span>&#123;</div><div class="line">        mQueue.quit(<span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quitSafely</span><span class="params">()</span> </span>&#123;</div><div class="line">        mQueue.quit(<span class="keyword">true</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看到都调用了 MessageQueue 的 quit 方法。看看 MessageQueue 的 quit 方法</p>
<p></p><h5><center>MessageQueue # quit(boolean safe)</center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">quit</span><span class="params">(<span class="keyword">boolean</span> safe)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!mQuitAllowed) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Main thread not allowed to quit."</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (mQuitting) &#123;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">           mQuitting = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (safe) &#123;</div><div class="line">               removeAllFutureMessagesLocked();</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               removeAllMessagesLocked();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// We can assume mPtr != 0 because mQuitting was previously false.</span></div><div class="line">           nativeWake(mPtr);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>若当前的 MessageQueue 实例属于主线程，那么调用主线程 Looper 的 quit（或 quitSafely）都会抛出这个异常，<code>mQuitAllowed</code>变量在 Looper 的 prepareMainLooper 方法中会被赋值为 false（具体在<code>private static void prepare(boolean quitAllowed)</code>方法中赋值）。</p>
<p>参照 loop 方法可知当 MessageQueue 的 next 方法返回为 null 时，loop 循环就会退出，由此可知，<code>removeAllMessagesLocked</code>方法会直接将下一个待处理消息置为 null，这样 next 方法调用时就会返回 null；<code>removeAllFutureMessagesLocked</code>方法则会在当前消息队列的队尾添加一个 null 消息，并拒绝再接收消息，那么当当前已有的消息处理完就会返回给 next 方法 null，loop 循环就会结束。</p>
<h4 id="5-Handler-的工作原理"><a href="#5-Handler-的工作原理" class="headerlink" title="5 Handler 的工作原理"></a>5 Handler 的工作原理</h4><blockquote>
<p>Handler 的工作主要包括消息的发送和接收。消息的发送可以通过 post 的一系列方法以及 send 的一系列方法来实现，post 的一系列方法最终是通过 send 的一系列方法来实现的。</p>
</blockquote>
<p>send 一系列方法：</p>
<ul>
<li>立即发送消息一条消息：sendMessage</li>
<li>发送空的延迟消息：sendEmptyMessageDelayed</li>
<li>立即发送一条空消息：sendEmptyMessage         </li>
<li>发送一条消息到队列头：sendMessageAtFrontOfQueue </li>
<li>在指定时间发送消息：sendMessageAtTime         </li>
<li>发送延迟消息：sendMessageDelayed        </li>
<li>在指定时间发送空消息：sendEmptyMessageAtTime   </li>
</ul>
<p>post 一系列方法：发送 Runnable 对象，内部调用的是 send 的一系列方法</p>
<ul>
<li>post </li>
<li>postDelayed  </li>
<li>postAtFrontOfQueue   </li>
<li>postAtTime</li>
<li>sendMessageAtTime </li>
</ul>
<p>send 和 post 的一系列方法最终的函数调用（真正进行消息发送操作）为 <code>sendMessageAtTime</code>，或是<code>sendMessageAtFrontOfQueue</code>方法，其他的 sendXXX 和 postXXX 方法最后都会转到这两个方法，对这两个方法进行分析如下</p>
<h5 id="5-1-sendMessageAtTime-方法"><a href="#5-1-sendMessageAtTime-方法" class="headerlink" title="5.1 sendMessageAtTime 方法"></a>5.1 sendMessageAtTime 方法</h5><p>send 的一系列方法中 sendMessage、sendEmptyMessageDelayed、sendEmptyMessage、sendMessageDelayed、sendEmptyMessageAtTime 方法；post 的一系列方法 post、postDelayed、postAtTime 方法的最终调用都为 sendMessageAtTime 方法。</p>
<p></p><h5><center>Handler # sendMessageAtTime(Message msg, long uptimeMillis) </center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtTime</span><span class="params">(Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">        MessageQueue queue = mQueue;</div><div class="line">        <span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</div><div class="line">            RuntimeException e = <span class="keyword">new</span> RuntimeException(</div><div class="line">                    <span class="keyword">this</span> + <span class="string">" sendMessageAtTime() called with no mQueue"</span>);</div><div class="line">            Log.w(<span class="string">"Looper"</span>, e.getMessage(), e);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>方法的第二个参数<code>uptimeMillis</code>文档中解释为：传递该消息的绝对时间，该时间将以 SystemClock.uptimeMillis（开机的到现在的毫秒数，不包括系统睡眠时间）的值作为基数。</p>
<p><code>sendMessageDelayed</code>或<code>sendMessageDelayed</code>方法内部会调用<code>sendMessageAtTime</code>方法，调用形式大都是这样的：<code>sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis)</code>,延迟时间（delayMillis）加上开机到现在的毫秒数即为发送该条消息的绝对时间，<code>sendMessage</code>方法中会调用<code>sendMessageDelayed</code>方法，此时传入的<code>delayMillis</code>就为 0 。</p>
<p>可以看到该方法内部首先会检查 mQueue 是否为 null，为 null 就表示当前线程没有 MessageQueue 对象，为什么没有 MessageQueue 对象，问问自己，MessageQueue 的实例应该在哪里实例化? 在Looper 的构造函数里，那 Looper 的构造函数又在哪里调用呢？ 在 Looper.prepare() …….，对了，很多时候程序抛出该异常就是因为你忘了调用 Looper.prepare() 方法。 </p>
<p>接下来调用 enqueueMessage 方法，看名字就可以猜出来其内部肯定会调用 MessageQueue 的 enqueueMessage 方法将消息插入到消息队列中。</p>
<p></p><h5><center>Handler # enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) </center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(MessageQueue queue, Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</div><div class="line">        msg.target = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">if</span> (mAsynchronous) &#123;</div><div class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h5 id="5-2-sendMessageAtFrontOfQueue-方法"><a href="#5-2-sendMessageAtFrontOfQueue-方法" class="headerlink" title="5.2 sendMessageAtFrontOfQueue 方法"></a>5.2 sendMessageAtFrontOfQueue 方法</h5><p>send 一系列方法的 sendMessageAtFrontOfQueue；post 一系列方法的 postAtFrontOfQueue 方法的最终调用为  sendMessageAtFrontOfQueue 方法。</p>
<p></p><h5><center>Handler # sendMessageAtFrontOfQueue(Message msg) </center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">sendMessageAtFrontOfQueue</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">    MessageQueue queue = mQueue;</div><div class="line">    <span class="keyword">if</span> (queue == <span class="keyword">null</span>) &#123;</div><div class="line">        RuntimeException e = <span class="keyword">new</span> RuntimeException(</div><div class="line">            <span class="keyword">this</span> + <span class="string">" sendMessageAtTime() called with no mQueue"</span>);</div><div class="line">        Log.w(<span class="string">"Looper"</span>, e.getMessage(), e);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> enqueueMessage(queue, msg, <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法同样会检查 mQueue 是否为 null。<br>注意这里调用<code>enqueueMessage</code>方法时传入的 <code>uptimeMillis</code> 的值为 0 ，你可以往上翻翻，找到 MessageQueue 的 <code>enqueueMessage(Message msg, long when)</code>方法的分析，此时传到 MessageQueue 的 enqueueMessage 方法里的     <code>when</code>的值就为 0 ，通过<code>MessageQueue#enqueueMessage</code>方法就可以知道，当 <code>when == 0</code>，该条消息将被插入消息队列的队头位置。</p>
<h5 id="5-3-总结"><a href="#5-3-总结" class="headerlink" title="5.3 总结"></a>5.3 总结</h5><blockquote>
<p>可以发现 Handler 发送消息的过程仅仅是向消息队列中插入一条消息，MessageQueue 的 next 方法就会返回 这条消息给 Looper，Looper 收到消息后开始处理，最终消息由 Handler 处理，即 Handler 的 dispatchMessage 方法会被调用，这时 Handler 就进入处理消息的阶段。 </p>
</blockquote>
<h5 id="5-4-Handler-的-dispatchMessage-方法"><a href="#5-4-Handler-的-dispatchMessage-方法" class="headerlink" title="5.4 Handler 的 dispatchMessage 方法"></a>5.4 Handler 的 dispatchMessage 方法</h5><blockquote>
<p>dispatchMessage 方法会检查消息（Message）的 callback 是否为 null，不为 null 就 通过 handleCallback 来处理消息，实际上就是 Handler 的一系列 post 方法传过来的 Runable 参数。</p>
</blockquote>
<p> </p><h5><center>Handler # dispatchMessage(Message msg) </center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;</div><div class="line">        handleCallback(msg);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        handleMessage(msg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>dispatchMessage 方法先会检查消息的 callback 是否为 null，其次检查 Handler 的 mCallback 是否为 null，不为 null 则调用其 handleMessage 方法，若该方法返回 true 则消息处理完成，否则（最后）调用 Handler 对象的 handleMessage 方法处理消息。</p>
<p>这里有个小技巧，Handler 的 mCallback 域，通常我们使用 Handler 的方法是使用其导出来（子类），或者是匿名内部类（实质也是子类），这是我们就需要覆写 Handler 的 handleMessage 方法。那如果不想通过继承的方式使用 Handler 呢，mCallback 就是一种途径：<br>Handler 提供了一个构造函数<code>public Handler(Callback callback)</code>，这就允许我们通过传参的方式使用 Handler。</p>
<p>上面提到的几个变量，Message 的 callback，Handler 的 mCallback，callback 是 Runnable 对象，mCallback 为 Handler 的内部类。</p>
<p> </p><h5><center>Handler # Callback  </center><p></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span></span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<hr>
<p>文章部分内容摘抄自《Android 开发艺术探索》第 10 章 —— Android 的消息机制，加上大部分自己的理解和总结，可能有错误，欢迎指正。</p>
<center><b><u><em>END</em></u><ub></ub></b></center></h5></h5></h5></h5></h5></h5></h5></h5></h5></h5></h5></h5></h5></h5></h5>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/13/Android-View-的工作原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="James Duan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Duan">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/13/Android-View-的工作原理/" itemprop="url">Android：View 的工作原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-13T18:53:29+08:00">
                2017-05-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Android-View-的工作原理"><a href="#Android-View-的工作原理" class="headerlink" title="Android-View 的工作原理"></a>Android-View 的工作原理</h3><blockquote>
<p>View 的工作流程主要指的是 measure、layout、draw 这三大流程，即测量、布局和绘制，其中 measure 确定 View 的测量宽/ 高，layout 确定 View 的最终宽/高和四个顶点的位置，而 draw 则将 View 绘制到屏幕。</p>
</blockquote>
<p>在介绍 View 的三大流程之前，需要先了解 ViewRoot、DecorView 和 MeasureSpec 的基本概念，才能更好的理解 View 的 measure、layout、draw过程。<br><br></p>
<h4 id="1-ViewRoot-和-DecorView"><a href="#1-ViewRoot-和-DecorView" class="headerlink" title="1 ViewRoot 和 DecorView"></a>1 ViewRoot 和 DecorView</h4><blockquote>
<ul>
<li>ViewRoot 对应于 ViewRootImpl 类，它是连接 WindowManager 和 DecorView 的纽带，View 的三大流程均是通过 ViewRoot 来完成的。<br><br></li>
<li>View 的绘制流程是从 ViewRoot 的 performTraversals 方法开始的，它经过 measure、layout 和 draw 三个过程才能最终将一个 View 绘制出来，<br><br></li>
<li>measure 决定了 View 的宽和高，measure 完成之后，可以通过 getMeasureHeight/Width 来获得 View 的测量宽和高，在几乎所有情况下它都是与 View 的最终宽高相等的（getHeight/Width）。 layout 过程决定了 View 的四个顶点和最终宽高，完成以后就可以通过 getTop/Left/Bottom/Right 来获得其四个顶点相对父容器的坐标。只有 draw 完成以后 View 的内容才会呈现到屏幕上。<br><br></li>
<li>DecorView 做为顶级 View ，一般情况其内部会包含一个竖直方向的 LinearLayout，该 LinearLayout 分为两部分，上面部分为 标题栏，下面为内容栏。内容栏为一个 id 为 android.R.id.content 的 FrameLayout，而平时开发使用 setContentView 时就是将 View 添加到这个 FrameLayout 中。<br>因此要在 Activity 中获得我们设置的 View，可通过如下方式获得：<br><code>View contentView = 
((ViewGroup)getWindow().getDecorView().findViewbyId(android.R.Id.content)).getChildAt(0);</code></li>
</ul>
</blockquote>
<h4 id="2-MeasureSpec"><a href="#2-MeasureSpec" class="headerlink" title="2 MeasureSpec"></a>2 MeasureSpec</h4><blockquote>
<p>MeasureSpec 代表一个 32 为的 int 值，高 2 位代表 SpecMode，低 30 位表示 SpecSize，SpecMode 指测量模式，SpecSize 指某种测量模式下的规格大小。</p>
</blockquote>
<h5 id="2-1-SpecMode-有三种"><a href="#2-1-SpecMode-有三种" class="headerlink" title="2.1 SpecMode 有三种"></a>2.1 SpecMode 有三种</h5><ul>
<li>UNSPECIFIED 父容器不对 View 有任何限制，要多大给多大，这种情况一般用于系统内部，表示一种测量的状态。<br><br></li>
<li>EXACTLY 父容器已经测出 View 所需的精确大小，这个时候 View 的最终大小就是 SpecSize 的值。<strong>它对应于 LayoutParams 中的 match_parent 和具体的数值这两种模式</strong>。<br><br></li>
<li>AT_MOST 父容器指定一个可用的最大大小即 SpecSize，View 的大小不能大于这个值，具体是什么要看不同 VIew 的具体实现。<strong>它对应于 LayoutParams 中的 warp_content</strong>。</li>
</ul>
<h5 id="2-2-MeasureSpec-和-LayoutParams-的对应关系"><a href="#2-2-MeasureSpec-和-LayoutParams-的对应关系" class="headerlink" title="2.2 MeasureSpec 和 LayoutParams 的对应关系"></a>2.2 MeasureSpec 和 LayoutParams 的对应关系</h5><p>MeasureSpec 的值是我们无法直接控制的，但我们可以通过给 View 设置 LayoutParams 来间接修改 MeasureSpec 的值。</p>
<blockquote>
<p>在 View 测量的时候，系统会将 LayoutParams 在父容器的约束下转换为对应的 MeasureSpec，然后根据这个 MeasureSpec 测量出 View 的宽高。需要注意的是父容器传给待测 View（子 View）的 MeasureSpec 的值由 子 View 的 LayoutParams 和父容器（父容器的 MeasureSpec）共同决定。</p>
</blockquote>
<p>子 View 的 MeasureSpec 赋值规则在<strong><code>ViewGroup#getChildMeasureSpec(int spec, int padding, int childDimension)</code></strong>方法中定义：<br>该方法的调用可在 ViewGroup 的 <code>measureChild</code>和<code>measureChildWithMargins</code>方法中找到。</p>
<p>赋值规则可总结为如下表格：<br><img src="http://img.blog.csdn.net/20170513185032164?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYWltZWltZWlUUw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"><br><br>由上表可以清晰的看出子 View 的 MeasureSpec 的确定规则，比如当父容器的 MeasureSpec 的 SpecMode 为 EXACTLY： </p>
<ul>
<li>子 View 的 LayoutParams (android:width/height)为具体数值（如20dp）时，子 View 的<code>onMeasure(int widthMeasureSpec, int heightMeasureSpec)</code>方法中得到的 MeasureSpec（widthMeasureSpec 或 heightMeasureSpec）的 SpecMode 将为 EXACTLY，SpecSize 为 20dp；<br><br></li>
<li>子 View 的 LayoutParams (android:width/height)为 match_parent 时，子 View 的 MeasureSpec 的 SpecMode 将为 EXACTLY，SpecSize 为父容器的大小；<br><br></li>
<li>子 View 的 LayoutParams (android:width/height)为 warp_content 时，子 View 的 MeasureSpec 的 SpecMode 将为 AT_MOST，SpecSiz 为父容器的大小。<br><br></li>
<li>UNSPECIFIED 主要用于系统内部多次 Measure 的情形，一般来说，不需要关注。</li>
</ul>
<h5 id="2-3-MeasureSpec-的传递"><a href="#2-3-MeasureSpec-的传递" class="headerlink" title="2.3 MeasureSpec 的传递"></a>2.3 MeasureSpec 的传递</h5><p>父容器（ViewGroup）传递给子 View 的 MeasureSpec 的值通过<strong><code>getChildMeasureSpec</code></strong>方法确定，父容器将多次调用该方法以分别求得子 View 的<code>widthMeasureSpec</code>和<code>widthMeasureSpec</code>，然后调用子 View 的<code>measure</code>方法，最终将子 View 的 MeasureSpec 传递到<code>onMeasure</code>方法中完成子 View 的测量。</p>
<h4 id="3-measure-过程"><a href="#3-measure-过程" class="headerlink" title="3 measure 过程"></a>3 measure 过程</h4><blockquote>
<p>measure 过程分情况来看，如果只是一个原始的 View（继承体系中没有 ViewGroup），那么通过 measure 方法就完成其测量过程，如果是 ViewGroup ，除了完成自己的测量过程外，还要遍历去调用子元素的 measure 方法，各个子元素再递归去执行这个流程，完成测量。</p>
</blockquote>
<h5 id="3-1-View-的-measure-过程"><a href="#3-1-View-的-measure-过程" class="headerlink" title="3.1 View 的 measure 过程"></a>3.1 View 的 measure 过程</h5><p>View 的 measure 过程由其 measure 方法控制，measure 方法内部会调用 onMeasure 方法完成具体的测量。</p>
<center><strong>View # onMeasure(int widthMeasureSpec, int heightMeasureSpec)</strong></center><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br><center><strong>View # getDefaultSize(int size, int measureSpec)</strong></center>

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">       <span class="keyword">int</span> result = size;</div><div class="line">       <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</div><div class="line">       <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</div><div class="line"></div><div class="line">       <span class="keyword">switch</span> (specMode) &#123;</div><div class="line">       <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</div><div class="line">           result = size;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> MeasureSpec.AT_MOST:</div><div class="line">       <span class="keyword">case</span> MeasureSpec.EXACTLY:</div><div class="line">           result = specSize;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>对 onMeasure 方法内调用的方法进行解释：</p>
<ul>
<li>getSuggestedMinimumWidth / Height()：返回视图应使用的建议最小宽度/高度<br>内部逻辑：如果 View 没有设置背景，那么返回 android:minWidth / minHeight 属性指定的值，这个值可以为 0 ；如果设置了背景，则返回 android:minWidth / minHeight 和背景的最小宽度/高度这两者中的最大值。<br><br></li>
<li>getDefaultSize(int size, int measureSpec)：该方法内部逻辑也比较简单，UNSPECIFIED 的情况我们不需要关注，在 AT_MOST 或 EXACTLY 模式下返回值 即为 width / heightMeasureSpec 的 SpecSize。<br><br></li>
<li>setMeasuredDimension(int measuredWidth, int measuredHeight)：该方法返回时我们就可以在 onLayout 中通过 getMeasureWidth 方法获得测量宽高了。</li>
</ul>
<h5 id="3-2-ViewGroup-的-measure-过程"><a href="#3-2-ViewGroup-的-measure-过程" class="headerlink" title="3.2 ViewGroup 的 measure 过程"></a>3.2 ViewGroup 的 measure 过程</h5><p> ViewGroup 除了完成自己的测量过程外，还要遍历去调用子元素的 measure 方法，各个子元素再递归去执行这个流程。</p>
<blockquote>
<p>和 View 不同的是，ViewGroup 是一个抽象类，因此它没有重写 View 的 onMeasure 方法，但它提供了一个叫 measureChildren 的方法。</p>
</blockquote>
 <center><strong>ViewGroup # measureChildren(int widthMeasureSpec, int heightMeasureSpec)</strong></center>

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildren</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> size = mChildrenCount;</div><div class="line">      <span class="keyword">final</span> View[] children = mChildren;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; ++i) &#123;</div><div class="line">          <span class="keyword">final</span> View child = children[i];</div><div class="line">          <span class="keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) != GONE) &#123;</div><div class="line">              measureChild(child, widthMeasureSpec, heightMeasureSpec);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
 <center><strong>ViewGroup # measureChild(View child, int parentWidthMeasureSpec,</strong><br>            <strong>int parentHeightMeasureSpec)</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChild</span><span class="params">(View child, <span class="keyword">int</span> parentWidthMeasureSpec,</span></span></div><div class="line">        <span class="keyword">int</span> parentHeightMeasureSpec) &#123;</div><div class="line">    <span class="keyword">final</span> LayoutParams lp = child.getLayoutParams();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</div><div class="line">            mPaddingLeft + mPaddingRight, lp.width);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</div><div class="line">            mPaddingTop + mPaddingBottom, lp.height);</div><div class="line"></div><div class="line">    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>measureChildren 方法会遍历子 View，并对子 View 执行测量流程，子 View 的测量流程调用在 measureChild 方法中开启， measureChild 方法内部会调用 getChildMeasureSpec 方法获得子 View 的 MeasureSpec ，<strong>然后调用子 View 的 measure 方法</strong>(如果子 View 为 ViewGroup 则递归回到 ViewGroup 的 measure 过程，如果子 View 为原始的 View，则到了 View 的 measure 过程，这一次递归即将结束)。<br><br>ViewGroup 作为抽象类并没有定义其测量的具体过程（抽象类只能实例化其子类，子类必须重写从 View 中继承来的 onMeasure 方法），比如 Linearlayout、RelativeLayout、FrameLayout等。<br><br>#### 4 layout 过程<br><br>&gt;Layout 的 作用是 ViewGroup 用来确定子元素的位置，当 ViewGroup 的位置确定后，它在 onLayout 中会遍历所有子元素并调用其 layout 方法，在 layout 方法中 onLayout 方法又会被调用。<br><br>##### 4.1 View 的 layout 过程<br><br>View 的 layout 方法定义如下：<br><code>public void layout(int l, int t, int r, int b)</code><br>&gt;layout 方法中会通过 setFrame 方法来设定 View 的四个顶点的位置，即初始化 mLeft，mRight，mTop 和 mBottom，View 的四个顶点一旦确定，那么 View 在父容器中的位置也就确定了。<br><br>在 layout 方法中会调用 onLayout 方法，但 View 基类并没有对 onLayout 方法定义具体的实现，onLayout 方法在 View 中的定义如下：<br> <center><strong>View # onLayout(boolean changed, int left, int top, int right, int bottom)</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">   &#125;</div></pre></td></tr></table></figure><br><br>##### 4.2 ViewGroup 的 layout 过程<br><br> <center><strong>ViewGroup # layout(int l, int t, int r, int b)</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!mSuppressLayout &amp;&amp; (mTransition == <span class="keyword">null</span> || !mTransition.isChangingLayout())) &#123;</div><div class="line">        <span class="keyword">if</span> (mTransition != <span class="keyword">null</span>) &#123;</div><div class="line">            mTransition.layoutChange(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.layout(l, t, r, b);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// record the fact that we noop'd it; request layout when transition finishes</span></div><div class="line">        mLayoutCalledWhileSuppressed = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>ViewGroup 的 layout 方法 调用了 View 的 layout 方法（<code>super.layout(l, t, r, b)</code>），而 View 的 layout 方法内部会调用 onLayout 方法，ViewGroup 覆写了 View 的 onLayout 方法，使 onLayout 方法成为抽象方法，那么 ViewGroup 的子类就必须提供 onLayout 的具体实现。即 ViewGroup 的 layout 依赖于抽象方法 onLayout（细节依赖抽象——依赖倒置原则）。<br><br>ViewGroup 和 View 对 onLayout 方法的声明如下：<br> <center><strong>ViewGroup # onLayout(boolean changed, int left, int top, int right, int bottom)</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed,</span></span></div><div class="line">           <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b);</div></pre></td></tr></table></figure><br><br>ViewGroup 完成自己的 layout 的同时需要遍历所有子元素开启子元素的 layout 过程，但开启子元素的 layout 过程这一点在 ViewGroup 基类中并没有体现，像 ViewGroup 的开启子元素的 measure 过程体现在 ViewGroup 的 measureChild 方法中，在 measureChild 方法中会调用子元素的 measure 方法。这是怎么回事呢？<br>这就又回到 ViewGroup 的 onLayout 方法上了，既然 ViewGroup 的 onLayout 方法是抽象的，那么开启子元素的 layout 过程就应该在 ViewGroup 的子类的 onLayout 方法中。举个栗子，FrameLayout 的 onLayout 方法：<br><br> <center><strong>FrameLayout# onLayout(boolean changed, int left, int top, int right, int bottom)</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">    layoutChildren(left, top, right, bottom, <span class="keyword">false</span> <span class="comment">/* no force left gravity */</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>看看 layoutChildren 方法。<br> <center><strong>FrameLayout# layoutChildren(int left, int top, int right, int bottom, boolean forceLeftGravity)</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom, <span class="keyword">boolean</span> forceLeftGravity)</span> </span>&#123;</div><div class="line">...</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">          <span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">          <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">              ...</div><div class="line">              <span class="keyword">switch</span> (verticalGravity) &#123;</div><div class="line">                  <span class="keyword">case</span> Gravity.TOP:</div><div class="line">                      childTop = parentTop + lp.topMargin;</div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  <span class="keyword">case</span> Gravity.CENTER_VERTICAL:</div><div class="line">                      childTop = parentTop + (parentBottom - parentTop - height) / <span class="number">2</span> +</div><div class="line">                      lp.topMargin - lp.bottomMargin;</div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  <span class="keyword">case</span> Gravity.BOTTOM:</div><div class="line">                      childTop = parentBottom - height - lp.bottomMargin;</div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  <span class="keyword">default</span>:</div><div class="line">                      childTop = parentTop + lp.topMargin;</div><div class="line">              &#125;</div><div class="line"></div><div class="line">              child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure><br><br>可以看到在 layoutChildren 方法中遍历了 FrameLayout 的子元素，并调用子元素的 layout 方法。<br><br>#### 5 draw 过程<br><br>View 的 draw 过程遵循如下步骤：<br><br>&gt;1. 绘制背景：background.draw(canvas)<br>&gt;2. 绘制自己：onDraw<br>&gt;3. 绘制children：dispatchDraw<br>&gt;4. 绘制装饰：onDrawScrollBars<br><br>该流程在 draw 源码中可以明显看出：<br><center><strong>View # draw(Canvas canvas) </strong></center><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@CallSuper</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> privateFlags = mPrivateFlags;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</div><div class="line">               (mAttachInfo == <span class="keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);</div><div class="line">       mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</div><div class="line"></div><div class="line">       <span class="comment">/*</span></div><div class="line">        * Draw traversal performs several drawing steps which must be executed</div><div class="line">        * in the appropriate order:</div><div class="line">        *</div><div class="line">        *      1. Draw the background</div><div class="line">        *      2. If necessary, save the canvas' layers to prepare for fading</div><div class="line">        *      3. Draw view's content</div><div class="line">        *      4. Draw children</div><div class="line">        *      5. If necessary, draw the fading edges and restore layers</div><div class="line">        *      6. Draw decorations (scrollbars for instance)</div><div class="line">        */</div><div class="line"></div><div class="line">       <span class="comment">// Step 1, draw the background, if needed</span></div><div class="line">       <span class="keyword">int</span> saveCount;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (!dirtyOpaque) &#123;</div><div class="line">           drawBackground(canvas);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// skip step 2 &amp; 5 if possible (common case)</span></div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</div><div class="line">       <span class="keyword">boolean</span> horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="number">0</span>;</div><div class="line">       <span class="keyword">boolean</span> verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="number">0</span>;</div><div class="line">       <span class="keyword">if</span> (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</div><div class="line">           <span class="comment">// Step 3, draw the content</span></div><div class="line">           <span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div><div class="line"></div><div class="line">           <span class="comment">// Step 4, draw the children</span></div><div class="line">           dispatchDraw(canvas);</div><div class="line"></div><div class="line">           <span class="comment">// Overlay is part of the content and draws beneath Foreground</span></div><div class="line">           <span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">               mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">// Step 6, draw decorations (foreground, scrollbars)</span></div><div class="line">           onDrawForeground(canvas);</div><div class="line"></div><div class="line">           <span class="comment">// we're done...</span></div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">      ...</div><div class="line">   &#125;</div></pre></td></tr></table></figure><br><br>draw 方法会依次调用上述流程的对应方法完成自己的绘制和子元素的绘制，这里重点来看看 dispatchDraw 方法，即 draw 流程的分发。<br><br><center><strong>View # dispatchDraw(Canvas canvas) </strong></center><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatchDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure><br><br>可见 View 并没有对 dispatchDraw 方法提供实现，说明其实现与具体的 View 相关。<br><br>##### 5.1 ViewGroup 的 dispatchDraw 方法<br><br>ViewGroup 对 dispatchDraw 方法定义了具体的实现，在方法内部调用了 drawChild 方法<br><br><center><strong>ViewGroup# drawChild(Canvas canvas, View child, long drawingTime) </strong></center><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">drawChild</span><span class="params">(Canvas canvas, View child, <span class="keyword">long</span> drawingTime)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> child.draw(canvas, <span class="keyword">this</span>, drawingTime);</div><div class="line">    &#125;</div></pre></td></tr></table></figure><br><br>可以看到在 drawChild 方法中会去调用子元素的 draw 方法开启子元素的 draw 流程。<br><br>———-<br>文章大部分内容摘抄自《Android 开发艺术探索》第 4 章 —— View 的工作原理，加上部分自己的理解和总结，可能有错误，欢迎指正。<br><br><center><strong><em>END</em> </strong></center>

</center></center></center></center></center></center>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/09/Android-View-的事件分发机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="James Duan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Duan">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/09/Android-View-的事件分发机制/" itemprop="url">Android：View 的事件分发机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-09T22:33:29+08:00">
                2017-05-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="Android-View的事件分发机制"><a href="#Android-View的事件分发机制" class="headerlink" title="Android-View的事件分发机制"></a>Android-View的事件分发机制</h4><ul>
<li>View 的事件由 MotionEvent 类表示，MotionEvent 定义了大量的常量来表示用户的手指（鼠标、手写笔、轨迹球）在屏幕上的各种状态。View 的事件分发机制指的就是 View （ViewGroup、Button等）在复杂的层级关系里对 MotionEvent 事件的分配和处理规则。</li>
<li>事件序列：当一次手指触摸屏幕行为开始，往往后续会连续触发一连串的事件，如：DOWN -&gt; ..MOVE.. -&gt; UP。也可以说从 <em>ACTION_DOWN</em> 开始到  <em>ACTION_UP</em> 事件到达的过程为一次事件序列。</li>
</ul>
<h5 id="一-MotionEvent"><a href="#一-MotionEvent" class="headerlink" title="一. MotionEvent"></a>一. MotionEvent</h5><p>MotionEvent 类的定义如下：<br><code>public final class MotionEvent extends InputEvent implements Parcelable</code><br>该类继承了 InputEvent （抽象类，输入事件的表示类），同时该类是可序列化的。</p>
<h6 id="1-1-常见的事件状态："><a href="#1-1-常见的事件状态：" class="headerlink" title="1.1 常见的事件状态："></a>1.1 常见的事件状态：</h6><ul>
<li><code>ACTION_DOWN</code><br>手指刚接触屏幕，按下的手势已经开始，此次事件序列的起始位置（坐标）被赋值。<br>-<code>ACTION_UP</code><br>手指从屏幕松开的一瞬间，按下的手势结束，此次事件序列结束，最终的结束位置（坐标）决定。</li>
<li><code>ACTION_MOVE</code><br>在接收到 ACTION_DOWN 之后，接收到 ACTION_UP 之前，在手指和屏幕保持接触的前提下手指的位置（坐标）发生了改变。</li>
</ul>
<h5 id="1-2-默认的规则"><a href="#1-2-默认的规则" class="headerlink" title="1.2 默认的规则"></a>1.2 默认的规则</h5><p><a id="rule"></a></p>
<blockquote>
<p>规则 1</p>
<blockquote>
<p>ViewGroup 默认不拦截任何事件。Android 源码中 ViewGroup 的 onInterceptTouchEvent 方法默认返回 false</p>
</blockquote>
<p>规则 2</p>
<blockquote>
<p>View 的 onTouchEvent 默认都会消耗事件（返回 true） ，除非他是不可点击的（clickable 、 longClickable 和 contextClickable 都为 false）。</p>
</blockquote>
<p>规则 3</p>
<blockquote>
<p>onCLick 会发生的前提是当前 View 是可点击的，并且它收到了 DOWN 和 UP 事件。</p>
</blockquote>
</blockquote>
<h5 id="二-触摸事件涉及到的主要方法"><a href="#二-触摸事件涉及到的主要方法" class="headerlink" title="二.  触摸事件涉及到的主要方法"></a>二.  触摸事件涉及到的主要方法</h5><ul>
<li><code>public boolean dispatchTouchEvent(MotionEvent event)</code><br>事件分发逻辑处理的主要方法，如果触摸事件传递到当前 View 那么该方法一定会被调用，返回结果受当前 View 的 onTouchEvent 和下级 View 的 dispatchTouchEvent 方法的影响，表示是否消耗掉当前事件。</li>
<li><code>public boolean onInterceptTouchEvent(MotionEvent event)</code><br>在 dispatchTouchEvent 方法中调用，用来判断是否拦截某个事件，如果当前 View 拦截了某个事件，那么在同一个事件序列中该方法不会再调用，返回结果表示是否拦截当前事件。 </li>
<li><code>public boolean onTouchEvent(MotionEvent event)</code><br>在 dispatchTouchEvent 方法中调用，用来处理触摸事件，返回结果表示是否消耗当前事件，如果不消耗，则在同一事件序列中，当前 View 无法再次接收到事件。</li>
</ul>
<h5 id="三-事件分发过程"><a href="#三-事件分发过程" class="headerlink" title="三. 事件分发过程"></a>三. 事件分发过程</h5><h6 id="3-1-ViewGroup-的-dispatchTouchEvent-方法"><a href="#3-1-ViewGroup-的-dispatchTouchEvent-方法" class="headerlink" title="3.1 ViewGroup 的 dispatchTouchEvent 方法"></a>3.1 ViewGroup 的 dispatchTouchEvent 方法</h6><ol>
<li>对于一个根 ViewGroup 来说，点击事件产生后，首先会传递给它，这时它的<code>dispatchTouchEvent</code>就会被调用：</li>
</ol>
<ul>
<li>如果这个 ViewGroup 的 <code>onInterceptTouchEvent</code>方法返回 true就表示它要拦截当前事件，接着事件就会交给这个 ViewGroup 处理，即它的 <code>onTouchEvent</code>方法就会被调用</li>
<li>如果这个 ViewGroup 的 <code>onInterceptTouchEvent</code> 方法返回 false 就表示它不拦截当前事件，这时当前事件就会继续传递给它的子元素，接着子元素的 <code>dispatchTouchEvent</code>方法就会被调用，如此反复直到最终事件被处理。</li>
</ul>
<ol>
<li>参照源码加深理解<br>源码 <code>dispatchTouchEvent</code> 方法比较复杂，这里分段从前往后选取关键部分依次进行分析。</li>
</ol>
<p>（1）判断当前 View（ViewGroup）是否拦截事件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">		-------------ViewGroup#dispatchTouchEvent---------------</div><div class="line"> public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line"> ...</div><div class="line">// Check for interception.</div><div class="line">            final boolean intercepted;</div><div class="line">            if (actionMasked == MotionEvent.ACTION_DOWN</div><div class="line">                    || mFirstTouchTarget != null) &#123;</div><div class="line">                final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0;</div><div class="line">                if (!disallowIntercept) &#123;</div><div class="line">                    intercepted = onInterceptTouchEvent(ev);</div><div class="line">                    ev.setAction(action); // restore action in case it was changed</div><div class="line">                &#125; else &#123;</div><div class="line">                    intercepted = false;</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                // There are no touch targets and this action is not an initial down</div><div class="line">                // so this view group continues to intercept touches.</div><div class="line">                intercepted = true;</div><div class="line">            &#125;</div><div class="line">            ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一句一句进行分析：</p>
<center><font size="+2"><strong><code>if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null)</code></strong>:</font></center><br>如果当前事件为 <em>ACTION_DOWN</em>，并且<code>mFirstTouchTarget</code>不为空，就进行后面的操作。那么<code>mFirstTouchTarget</code>是什么呢？<br>&gt;根据 ViewGroup 的 onDispatchTouchEvent 方法后面部分得分析可知，当事件由 <em>ViewGroup</em>的子元素成功处理时（ViewGroup）没有进行拦截，mFirstTouchTarget 将被赋值，并指向其子元素，反过来，如果<em>ViewGroup</em>对事件进行拦截，mFirstTouchTarget != null 就不成立。<br><br>大家可能疑惑这句将<code>mFirstTouchTarget</code>是否为空作为判断条件，而<code>mFirstTouchTarget</code>的赋值却在这个<code>if()</code>判断之后，那<code>mFirstTouchTarget</code>不是一定为 null！<br>    <code>mFirstTouchTarget</code>作为全局变量，当<code>dispatchTouchEvent</code><strong>第一次</strong>被调用时其值一定为空，而<code>actionMasked == MotionEvent.ACTION_DOWN</code>一定为 true ，这时，ViewGroup 的 <code>onInterceptTouchEvent</code>会被调用，如果其返回为 true，表示要拦截（那么 intercepted 为 true，mFirstTouchTarget 将不被赋值为空），那么此次的 <em>ACTION_DOWN</em>事件就被拦截，<em>ACTION_DOWN</em>是一次事件序列的开始，那么当此次事件序列的下一个事件到达调用<code>dispatchTouchEvent</code>方法并运行到<code>if()</code>时，该<code>if()</code>将为 false（此时 <code>actionMasked != MotionEvent.ACTION_DOWN</code>且<code>mFirstTouchTarget  == null</code>），则 <code>intercepted = true</code>，这就得出一个结论：<br>&gt;结论 1<br>&gt;&gt;某个 View 一旦决定拦截，那么这一事件序列都只能由它来处理（如果事件序列能够传递给他的话），并且它的 onInterceptTouchEvent 不会再被调用。<br><br><center><font size="+2"><strong><code>final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0;if (!disallowIntercept) {...</code></strong></font></center><br>这句中使用到了一个标记位<code>FLAG_DISALLOW_INTERCEPT</code>，那么这个标记位是否启用是由谁决定、怎么决定的呢？<br>这里我们讨论的是 ViewGroup 的    <code>dispatchTouchEvent</code> 方法，<code>dispatchTouchEvent</code> 方法如果不拦截事件，那么 ViewGroup 就会将事件传递给它的子 View，这时子 View 可以通过其所在容器（父视图 ViewGroup）的引用调用 ViewGroup 的 <code>requestDisallowInterceptTouchEvent(boolean disallowIntercept)</code>方法改变 ViewGroup 的行为（启用或停用<code>FLAG_DISALLOW_INTERCEPT</code>标记位），使 ViewGroup 不再拦截除 ACTION_DOWN 以外的其它事件。<br><br>为什么说除了 ACTION_DOWN 以外的事件呢？<br>&gt;这是因为 ViewGroup 在分发事件时，如果是 ACTION_DOWN 事件就会重置 <code>FLAG_DISALLOW_INTERCEPT</code>标记位，使该标记位失效，即当面对 ACTION_DOWN 事件时，ViewGroup 总会调用自己的 <code>onInterceptTouchEvent</code>方法来询问自己是否要拦截事件。这一点在源码中也有体现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Handle an initial down.</span></div><div class="line">            <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">                <span class="comment">// Throw away all previous state when starting a new touch gesture.</span></div><div class="line">                <span class="comment">// The framework may have dropped the up or cancel event for the previous gesture</span></div><div class="line">                <span class="comment">// due to an app switch, ANR, or some other state change.</span></div><div class="line">                cancelAndClearTouchTargets(ev);</div><div class="line">                resetTouchState();</div><div class="line">            &#125;</div></pre></td></tr></table></figure><br><br>&gt;结论 2<br>&gt;&gt;事件传递是由外向内的，即事件总是先传递给父元素，然后再由父元素分发给子元素，通过 requestDisallowInterceptTouchEvent 方法可以在子元素中干预父元素的事件分发过程，但是 ACTION_DOWN 事件除外。<br><br>（2）ViewGroup 不拦截事件，将事件分发给子 View<br><br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">       -------------ViewGroup#dispatchTouchEvent---------------</div><div class="line">public boolean dispatchTouchEvent(MotionEvent ev) &#123;</div><div class="line">...</div><div class="line">						final View[] children = mChildren;</div><div class="line">                        for (int i = childrenCount - 1; i &gt;= 0; i--) &#123;</div><div class="line">                            final int childIndex = getAndVerifyPreorderedIndex(</div><div class="line">                                    childrenCount, i, customOrder);</div><div class="line">                            final View child = getAndVerifyPreorderedView(</div><div class="line">                                    preorderedList, children, childIndex);</div><div class="line"></div><div class="line">                            // If there is a view that has accessibility focus we want it</div><div class="line">                            // to get the event first and if not handled we will perform a</div><div class="line">                            // normal dispatch. We may do a double iteration but this is</div><div class="line">                            // safer given the timeframe.</div><div class="line">                            if (childWithAccessibilityFocus != null) &#123;</div><div class="line">                                if (childWithAccessibilityFocus != child) &#123;</div><div class="line">                                    continue;</div><div class="line">                                &#125;</div><div class="line">                                childWithAccessibilityFocus = null;</div><div class="line">                                i = childrenCount - 1;</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            if (!canViewReceivePointerEvents(child)</div><div class="line">                                    || !isTransformedTouchPointInView(x, y, child, null)) &#123;</div><div class="line">                                ev.setTargetAccessibilityFocus(false);</div><div class="line">                                continue;</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            newTouchTarget = getTouchTarget(child);</div><div class="line">                            if (newTouchTarget != null) &#123;</div><div class="line">                                // Child is already receiving touch within its bounds.</div><div class="line">                                // Give it the new pointer in addition to the ones it is handling.</div><div class="line">                                newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line">                                break;</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            resetCancelNextUpFlag(child);</div><div class="line">                            if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) &#123;</div><div class="line">                                // Child wants to receive touch within its bounds.</div><div class="line">                                mLastTouchDownTime = ev.getDownTime();</div><div class="line">                                if (preorderedList != null) &#123;</div><div class="line">                                    // childIndex points into presorted list, find original index</div><div class="line">                                    for (int j = 0; j &lt; childrenCount; j++) &#123;</div><div class="line">                                        if (children[childIndex] == mChildren[j]) &#123;</div><div class="line">                                            mLastTouchDownIndex = j;</div><div class="line">                                            break;</div><div class="line">                                        &#125;</div><div class="line">                                    &#125;</div><div class="line">                                &#125; else &#123;</div><div class="line">                                    mLastTouchDownIndex = childIndex;</div><div class="line">                                &#125;</div><div class="line">                                mLastTouchDownX = ev.getX();</div><div class="line">                                mLastTouchDownY = ev.getY();</div><div class="line">                                newTouchTarget = addTouchTarget(child, idBitsToAssign);</div><div class="line">                                alreadyDispatchedToNewTouchTarget = true;</div><div class="line">                                break;</div><div class="line">                            &#125;</div><div class="line">                   ...</div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br><center><font size="+2"><code>for (int i = childrenCount - 1; i &gt;= 0; i--) {...</code></font><br></center><br>将事件分发给子 View 的过程通过遍历每一个子 View，判断子 View是否能接收到事件，能就调用其 <code>dispatchTouchEvent</code>方法，若子 View 的 <code>dispatchTouchEvent</code>方法返回 false ，表示子 View 未消耗事件，则继续循环；如果子 View 的 <code>dispatchTouchEvent</code>方法返回 true，表示子 View 消耗了事件，那么<code>mFirstTouchTarget</code>将被赋值，同时结束循环。<br>- 如何判断子 View 是否能接收到事件：<br>子元素是否在播放动画<br>点击事件的坐标是否落在子元素的区域内<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">if (childWithAccessibilityFocus != null) &#123;</div><div class="line">	...</div><div class="line">&#125;</div><div class="line">if (!canViewReceivePointerEvents(child) || !isTransformedTouchPointInView(x, y, child, null)) &#123;</div><div class="line">	...</div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure><br><br>- <code>mFirstTouchTarget</code>的赋值：对应代码为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">newTouchTarget = addTouchTarget(child, idBitsToAssign);</div><div class="line">alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</div><div class="line"><span class="keyword">break</span>;</div></pre></td></tr></table></figure><br><br>具体的赋值在<code>addTouchTarget</code>方法内部。<br>- 遍历所有子元素都没有被处理：这包含两种情况，第一种为 ViewGroup 没有子元素，第二种是子元素处理了点击事件，但 子元素的 <code>dispatchTouchEvent</code>方法返回了false（这一般是因为子元素在<code>onTouchEvent</code>方法中返回了false），此时 ViewGroup 将自己处理事件。<br>结论：<br><a id="result3"></a><br>&gt;结论 3<br>&gt;&gt;某个 View 一旦开始处理事件，如果它不消耗 ACTION_DOWN 事件（onTouchEvent返回false），那么同一事件序列中的其他事件都不会再交给它来处理，并且事件将重新交由它的父元素去处理，即父元素的 onTouchEvent 会被调用。意思就是事件一旦交给一个 View 来处理，那么它就必须消耗掉，否则同一事件序列中剩下的事件就不再交给它来处理。<br><br><br> 这个结论可以结合代码来理解：<br><strong><code>某个 View 一旦开始处理事件</code></strong>：在开始循环前各个关键变量的值应该是这样的：<br>1.<code>mFirstTouchTarget</code>一定为空<br>2.<code>intercepted</code>一定为 false<br>3.可以推出<code>actionMasked == MOtionEvent.ACTION_DOWN</code>（这里参照 3.1 的部分）。<br><br> 之后遍历子 View 开始，在确定了<strong>某一个</strong>子 View <em>CV</em> 能接收到事件后，调用<em>CV</em>的<code>dispatchTouchEvent</code>方法（<code>dispatchTransformedTouchEvent</code>方法内部）：<br> - 若<code>dispatchTouchEvent</code>返回 true ，表示<em>CV</em>消耗了<strong>ACTION_DOWN</strong>事件，这时对<code>mFirstTouchTarget</code>赋值，使其指向<em>CV</em>，并跳出循环。当此次事件序列的下一个事件到达，假设为 ACTION_MOVE，此时<code>mFirstTouchTarget != null</code>成立，如果<em>CV</em>调用了<code>requestDisallowInterceptTouchEvent</code>方法启用<code>FLAG_DISALLOW_INTERCEPT</code>标记位（<code>disallowIntercept 为 true</code>），则 <code>intercepted</code>为 false，若<code>FLAG_DISALLOW_INTERCEPT</code>标记位没有被启用，那么 ViewGroup 的 <code>onInterceptTouchEvent</code>再次调用，参考 <a href="#rule">规则 1 </a>可以知道，一般情况下<code>intercepted</code>也会为 false，那么 <strong>同一事件序列中的其他事件都会交给它处理</strong>。<br> - 若<code>dispatchTouchEvent</code>返回 false，即 <em>CV</em> 不消耗 ACTION_DOWN 事件（onTouchEvent返回false）,此时会继续往下遍历子 View，如果遍历结束都没有被处理，那么 ViewGroup 将自己处理该事件，即<strong>父元素的 onTouchEvent 会被调用</strong>。<br><br>###### 3.2 View 的 dispatchTouchEvent 方法<br><br>View 的<code>dispatchTouchEvent</code>方法要简单一些，这里的 View 不包括 ViewGroup 。<br>&gt;View（不包括 ViewGroup）做为一个单独的元素，它没有子元素无法向下传递事件，所以只能自己处理事件。<br><br>（一） 事件传递到了某一个具体的 View 那就表明该 View 能接收到触摸事件，传递过来的第一个事件一定是此次事件序列的 <code>ACTION_DOWN</code> 事件，如果 View 消耗了 <code>ACTION_DOWN</code> 事件（返回true），那么该事件序列的后续事件都会传递给他，如果没消耗 <code>ACTION_DOWN</code> ，那么它将无法收到后续事件。参考  <a href="#result3">结论 3 </a><br><br>如果 View 只想处理 <code>ACTION_DOWN</code> 事件，而不处理其他事件，那可以覆写 <code>dispatchTouchEvent</code>方法或通过设置监听器实现（<code>setOnTouchListener(OnTouchListener l)</code>），在方法中加入如下判断即可：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="keyword">if</span>(event.getAction() == MotionEvent.ACTION_DOWN)</div><div class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">...</div></pre></td></tr></table></figure><br><br>（二） 内部监听和外部监听<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">-------------View#dispatchTouchEvent---------------</div><div class="line"> public boolean dispatchTouchEvent(MotionEvent event) &#123;</div><div class="line">...</div><div class="line">        if (onFilterTouchEventForSecurity(event)) &#123;</div><div class="line">            if ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(event)) &#123;</div><div class="line">                result = true;</div><div class="line">            &#125;</div><div class="line">            //noinspection SimplifiableIfStatement</div><div class="line">            ListenerInfo li = mListenerInfo;</div><div class="line">            if (li != null &amp;&amp; li.mOnTouchListener != null</div><div class="line">                    &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line">                    &amp;&amp; li.mOnTouchListener.onTouch(this, event)) &#123;</div><div class="line">                result = true;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line">                result = true;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">...</div><div class="line">        return result;</div><div class="line">    &#125;</div></pre></td></tr></table></figure><br><br>&gt;从源码可以看出，首先会判断有没有设置 OnTouchListener ，如果有，并且 OnTouchListener 中的 onTouch 方法返回 true，那么 onTouchEvent 就不会被调用，可见 OnTouchListener 的优先级高于 OnTouchEvent，这样做的好处是方便在外界处理触摸事件。<br><br>所以如果想屏蔽 View 默认的触摸事件处理只需为 View 设置监听器并返回 true 即可。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">view.setOnTouchListener(<span class="keyword">new</span> View.OnTouchListener() &#123;</div><div class="line">	  <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouch</span><span class="params">(View v, MotionEvent event)</span> </span>&#123;</div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line"> &#125;);</div></pre></td></tr></table></figure><br><br>（三）View 的 onTouchEvent 对 DISEABLED 的处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">     <span class="keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED) &#123;</div><div class="line">         <span class="keyword">if</span> (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != <span class="number">0</span>) &#123;</div><div class="line">             setPressed(<span class="keyword">false</span>);</div><div class="line">         &#125;</div><div class="line">         <span class="comment">// A disabled view that is clickable still consumes the touch</span></div><div class="line">         <span class="comment">// events, it just doesn't respond to them.</span></div><div class="line">         <span class="keyword">return</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE</div><div class="line">                 || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE)</div><div class="line">                 || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE);</div><div class="line">     &#125;</div><div class="line">...</div><div class="line">     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure><br><br>&gt;从源码可看出，当 View 处于不可用状态时，只要 CLICKABLE ，LONG_CLICKABLE 和 CONTEXT_CLICKABLE  有一者为 true，onTouchEvent 就会返回 true，即消耗事件。<br><br>这里有个<code>CONTEXT_CLICKABLE</code>，这个常量指的又是什么呢？<br><code>CONTEXT_CLICKABLE</code>是 Android SDK 23 （Android 6.0）加入的，表示触控笔上下文单击（触控笔按钮）和鼠标右键单击是否可用。为其设置监听器时应使用 onContextClick 代替 onStylusButtonPress。<br><br>（四）View 的 onTouchEvent 对点击事件的实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">      <span class="keyword">if</span> (((viewFlags &amp; CLICKABLE) == CLICKABLE ||</div><div class="line">             (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) ||</div><div class="line">             (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) &#123;</div><div class="line">       <span class="keyword">switch</span> (action) &#123;</div><div class="line">       <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">        ...</div><div class="line">                         <span class="keyword">if</span> (!focusTaken) &#123;</div><div class="line">                             <span class="comment">// Use a Runnable and post this rather than calling</span></div><div class="line">                             <span class="comment">// performClick directly. This lets other visual state</span></div><div class="line">                             <span class="comment">// of the view update before click actions start.</span></div><div class="line">                             <span class="keyword">if</span> (mPerformClick == <span class="keyword">null</span>) &#123;</div><div class="line">                                 mPerformClick = <span class="keyword">new</span> PerformClick();</div><div class="line">                             &#125;</div><div class="line">                             <span class="keyword">if</span> (!post(mPerformClick)) &#123;</div><div class="line">                                 performClick();</div><div class="line">                             &#125;</div><div class="line">                         &#125;</div><div class="line">                     &#125;</div><div class="line">...</div><div class="line">     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure><br><br>&gt;当 ACTION_UP 事件到达时，会触发 performClick 方法，如果 View 设置了 OnClickListener，那么 performClick 内部会调用它的 onClick 方法。<br><br>注释中说明了要使用 post 方法通过 Handler 执行 onClick，这让我们能够在 onClick 执行之前看到 View 的状态更新。<br><br>（五）CLICKABLE ，LONG_CLICKABLE 和 CONTEXT_CLICKABLE  的设置<br>&gt;View 的 LONG_CLICKABLE 属性默认为 false ，而 CLICKABLE 属性是否为 false 和具体的 View 相关，确切来说是可点击的 View 的 CLICKABLE 为 true ，不可点击的 View 的 CLICKABLE 为 false，比如 Button 是可点击的，而 TextView 是不可点击 的。通过 setClickable 、 setLongClickable 和 setContextClickable 可修改三者的值。另外，setOnClickListener、setOnLongClickListener 和 setOnContextClickListener 方法内部会自动将 View 的对应属性的 XXXable 值改为 true。<br><br>文章大部分摘抄自《Android 开发艺术探索》，第三章 3.4 节 —— View的事件分发机制，加上部分自己的理解，可能有错误，欢迎指正。<br><center><u><b><em>END</em></b></u></center>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/04/Android-自定义View和属性动画ValueAnimator实现圆点指示器——支持“纵向视图”/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="James Duan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Duan">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/04/Android-自定义View和属性动画ValueAnimator实现圆点指示器——支持“纵向视图”/" itemprop="url">Android：自定义View和属性动画ValueAnimator实现圆点指示器——支持“纵向视图”</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-04T10:08:11+08:00">
                2017-05-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="圆点指示器支持“纵向视图”啦"><a href="#圆点指示器支持“纵向视图”啦" class="headerlink" title="圆点指示器支持“纵向视图”啦"></a>圆点指示器支持“纵向视图”啦</h4><p>关于圆点指示器的实现请参看上一篇博文：<a href="http://blog.csdn.net/aimeimeits/article/details/69370853" target="_blank" rel="external">自定义View和属性动画ValueAnimator实现圆点指示器</a><br>该篇文章将对支持纵向视图过程的关键代码和使用方法进行介绍。</p>
<p>控件元素的构成<br>| 小圆点 | 指示点 | 线段 |<br>| :—– | :— | :—- |<br>|圆|椭圆|矩形|</p>
<h5 id="一-效果图"><a href="#一-效果图" class="headerlink" title="一 效果图"></a>一 效果图</h5><p><img src="http://img.blog.csdn.net/20170504085814432?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYWltZWltZWlUUw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h5 id="二-如何使用"><a href="#二-如何使用" class="headerlink" title="二 如何使用"></a>二 如何使用</h5><p>使用时只需在你的<code>xml</code>布局文件中指定<code>indicatorOrientation</code>属性为<code>vertical</code>即可。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">com.duan.indicatorviewdemo.IndicatorView</span></span></div><div class="line"></div><div class="line">            <span class="attr">app:indicatorOrientation</span>=<span class="string">"vertical"</span></div><div class="line">            </div><div class="line">           <span class="attr">android:layout_marginLeft</span>=<span class="string">"30dp"</span></div><div class="line">           <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">           <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">           <span class="attr">app:dotNum</span>=<span class="string">"5"</span></div><div class="line">           <span class="attr">app:dotSize</span>=<span class="string">"20dp"</span></div><div class="line">           <span class="attr">app:indicatorSize</span>=<span class="string">"20dp"</span></div><div class="line">           <span class="attr">app:dotColor</span>=<span class="string">"#a5b7b3"</span></div><div class="line">           <span class="attr">app:indicatorColor</span>=<span class="string">"#52ffda"</span></div><div class="line">           <span class="attr">app:lineColor</span>=<span class="string">"#cacaca"</span></div><div class="line">           <span class="attr">app:lineLength</span>=<span class="string">"90dp"</span></div><div class="line">           <span class="attr">app:lineWidth</span>=<span class="string">"4dp"</span> /&gt;</div></pre></td></tr></table></figure></p>
<h5 id="三-关键代码"><a href="#三-关键代码" class="headerlink" title="三 关键代码"></a>三 关键代码</h5><h6 id="3-1-attr-中添加方向属性定义"><a href="#3-1-attr-中添加方向属性定义" class="headerlink" title="3.1 attr 中添加方向属性定义"></a>3.1 attr 中添加方向属性定义</h6><p>本项目在attr.xml文件中添加如下属性定义，并将该属性添加到<code>declare-styleable</code>中：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"indicatorOrientation"</span> <span class="attr">format</span>=<span class="string">"integer"</span>&gt;</span> <span class="comment">&lt;!--控件方向--&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">"vertical"</span> <span class="attr">value</span>=<span class="string">"0"</span>/&gt;</span> <span class="comment">&lt;!--纵向--&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">"horizontal"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span> <span class="comment">&lt;!--水平--&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">attr</span>&gt;</span></div><div class="line"></div><div class="line"> <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"IndicatorView"</span>&gt;</span>  </div><div class="line">...</div><div class="line">   <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"indicatorOrientation"</span>/&gt;</span></div><div class="line">...</div><div class="line"> <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h6 id="3-2-修改-IndicatorView-java"><a href="#3-2-修改-IndicatorView-java" class="headerlink" title="3.2 修改 IndicatorView.java"></a>3.2 修改 IndicatorView.java</h6><ul>
<li><p>添加<code>mIndicatorOrientation</code>变量，并在构造函数中获得<code>xml</code>布局文件中指定的值，默认为水平方向。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//默认为 水平</span></div><div class="line">        mIndicatorOrientation = array.getInteger(R.styleable.IndicatorView_indicatorOrientation, INDICATOR_ORIENTATION_HORIZONTAL);</div></pre></td></tr></table></figure>
</li>
<li><p>onMeasure 方法<br>onMeasure 方法需要处理 xml 布局文件设置宽高为<code>warp_content</code>的情况，此时需要计算出控件的实际宽和高。<br>在该方法中判断当设置为“纵向视图”时，宽和高的计算方法为：<br>宽 = 左内边距 + 右内边距 + 指示点大小<br>高 = 上内边距 + 下内边距 + 线段总长 + 指示点大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">if (widthMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">            width = widthSize;</div><div class="line">        &#125; else &#123;//xml中宽度设为warp_content</div><div class="line">            if (mIndicatorOrientation == INDICATOR_ORIENTATION_VERTICAL) //纵向</div><div class="line">                width = getPaddingLeft() + getPaddingRight() + mIndicatorSize;</div><div class="line">            else</div><div class="line">                width = getPaddingLeft() + ((mDotCount - 1) * mLineLength + mIndicatorSize) + getPaddingRight();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (heightMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">            height = heightSize;</div><div class="line">        &#125; else &#123;</div><div class="line">            if (mIndicatorOrientation == INDICATOR_ORIENTATION_VERTICAL) //纵向</div><div class="line">                height = ((mDotCount - 1) * mLineLength + mIndicatorSize) + getPaddingBottom() + getPaddingTop();</div><div class="line">            else</div><div class="line">                height = getPaddingTop() + mIndicatorSize + getPaddingBottom();</div><div class="line">        &#125;</div><div class="line">        ...</div></pre></td></tr></table></figure>
</li>
<li><p>onLayout 方法<br>在 onLayout 方法中会初始化存储指示点属性值的类，在这里需要对不同的控件方向做不同的处理。<br>控件为“纵向视图”时，指示点（椭圆）的中心的横坐标是固定的，中心的纵坐标与当前指示点所在的位置有关。而控件为“水平视图”时纵坐标固定，横坐标与所在位置有关</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if (mIndicatorOrientation == INDICATOR_ORIENTATION_VERTICAL) &#123; //纵向</div><div class="line">               indicatorHolder.setCenterX(getWidth() / 2);</div><div class="line">               indicatorHolder.setCenterY(mIndicatorPos * mLineLength + getPaddingBottom() + mIndicatorSize / 2);</div><div class="line">           &#125; else &#123;</div><div class="line">               indicatorHolder.setCenterX(mIndicatorPos * mLineLength + getPaddingLeft() + mIndicatorSize / 2);</div><div class="line">               indicatorHolder.setCenterY(getHeight() / 2);</div><div class="line">           &#125;</div></pre></td></tr></table></figure>
<ul>
<li>onDraw 方法绘制线段<br>线段使用的是<code>Canvas</code>的<code>drawRect(float left, float top, float right, float bottom, @NonNull Paint paint)</code>方法绘制的。<br>画线段时需要对控件方向做出判断，控件为“纵向视图”时，线段（矩形）的 left 和 right 是固定的，而 top 和 bottom 与当前正在绘制的线段有关。“水平视图”时 top 和 bottom 固定，right 和 left 与当前正在绘制的线段有关。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> ...</div><div class="line">    <span class="keyword">if</span> (mIndicatorOrientation == INDICATOR_ORIENTATION_VERTICAL) &#123; <span class="comment">//纵向</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mDotCount - <span class="number">1</span>; i++) &#123;</div><div class="line">            <span class="keyword">int</span> top = getHeight() - (getPaddingBottom() + mIndicatorSize / <span class="number">2</span> + mLineLength * (i + <span class="number">1</span>));</div><div class="line">            <span class="keyword">int</span> bottom = getHeight() - (getPaddingBottom() + mIndicatorSize / <span class="number">2</span> + mLineLength * i);</div><div class="line">            <span class="keyword">int</span> left = (getWidth() - mLineWidth) / <span class="number">2</span>;</div><div class="line">            <span class="keyword">int</span> right = (getWidth() + mLineWidth) / <span class="number">2</span>;</div><div class="line"></div><div class="line">            canvas.drawRect(left, top, right, bottom, mPaint);</div><div class="line">            &#125;</div><div class="line">...</div></pre></td></tr></table></figure>
<ul>
<li>onDraw 方法绘制小圆点<br>小圆点使用的是<code>Canvas</code>的<code>drawCircle(float cx, float cy, float radius, @NonNull Paint paint)</code>方法，当控件为“纵向视图”时，cx 值是固定的，cy 需要计算。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="keyword">if</span> (mIndicatorOrientation == INDICATOR_ORIENTATION_VERTICAL) &#123; <span class="comment">//纵向</span></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; clickableAreas.length; i++) &#123;</div><div class="line">                <span class="keyword">int</span> cx = getWidth() / <span class="number">2</span>;</div><div class="line">                <span class="keyword">int</span> cy = i * mLineLength + getPaddingBottom() + mIndicatorSize / <span class="number">2</span>;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (switchTo != -<span class="number">1</span> &amp;&amp; i == switchTo)</div><div class="line">                    mPaint.setColor(mIndicatorColor);</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    mPaint.setColor(mDotColor);</div><div class="line"></div><div class="line">                canvas.drawCircle(cx, cy, mDotSize, mPaint);</div><div class="line">                clickableAreas[i][<span class="number">0</span>] = cx;</div><div class="line">                clickableAreas[i][<span class="number">1</span>] = cy;</div><div class="line">            &#125;</div><div class="line">            ...</div></pre></td></tr></table></figure>
<ul>
<li><p>onDraw 方法绘制指示点<br>指示点的绘制时根据<code>indicatorHolder</code>对象中存的属性值进行绘制的(getter方法)，所有无需修改，需要修改的是对<code>indicatorHolder</code>对象值的控制(setter操作)，即平移动画的定义和“挤压”动画的定义。</p>
</li>
<li><p>onTouchEvent 方法<br>onTouchEvent 监听对控件的触摸事件，这个方法里需要修改连个地方<br>1 判断当前手指所在的小圆点：为“水平视图”时是根据<code>event.getX()</code>的值判断所在小圆点的位置，为“纵向视图”时应该根据<code>event.getY()</code>来判断。<br>2 当用户“拖拽”指示点时：为“水平视图”时这里要修改<code>indicatorHolder</code>的中心的横坐标，为“纵向视图”则应该修改其中心的纵坐标。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"> <span class="keyword">int</span> ey = (<span class="keyword">int</span>) event.getY();</div><div class="line"> ...</div><div class="line"> <span class="comment">//纵向</span></div><div class="line">   <span class="keyword">for</span> (; switchTo &lt; mDotCount; switchTo++) &#123;</div><div class="line">                <span class="keyword">int</span>[] xy = clickableAreas[switchTo];</div><div class="line">                <span class="comment">//只对y坐标位置进行判断，这样即使用户手指在控件外面（先在控件内触摸后不抬起而是滑到控件外面）滑动也能判断</span></div><div class="line">                <span class="keyword">if</span> (ey &lt;= xy[<span class="number">1</span>] + temp &amp;&amp; ey &gt;= xy[<span class="number">1</span>] - temp) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">...</div><div class="line"><span class="keyword">if</span> (mIndicatorOrientation == INDICATOR_ORIENTATION_VERTICAL) &#123; <span class="comment">//纵向</span></div><div class="line">                    indicatorHolder.setCenterY(ey);</div><div class="line">                &#125; </div><div class="line">                ...</div></pre></td></tr></table></figure>
</li>
<li><p>指示点切换动画<br>平移动画：为“纵向视图”时平移动画应在<code>indicatorHolder</code>中心的纵坐标上做变化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"> <span class="keyword">if</span> (mIndicatorOrientation == INDICATOR_ORIENTATION_VERTICAL) &#123; <span class="comment">//纵向</span></div><div class="line">            <span class="keyword">int</span> start = indicatorHolder.getCenterY();</div><div class="line">            end = switchTo * mLineLength + getPaddingBottom() + mIndicatorSize / <span class="number">2</span>;</div><div class="line">            trainsAnim = ObjectAnimator.ofInt(indicatorHolder, <span class="string">"centerY"</span>, start, end);</div><div class="line">        &#125;</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
</ul>
<p>挤压动画：为“纵向视图”时挤压动画改变<code>indicatorHolder</code>的宽度（centerW）因为线段的宽度，高度（centerH）为指示点当前所在位置和目标点间的距离。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="keyword">if</span> (mIndicatorOrientation == INDICATOR_ORIENTATION_VERTICAL) &#123; <span class="comment">//纵向</span></div><div class="line">                        centerH = Math.abs(indicatorHolder.getCenterY() - clickableAreas[switchTo][<span class="number">1</span>]);</div><div class="line">                        centerW = mLineWidth;</div><div class="line">                    &#125; </div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>不使用动画：此时判断为“纵向视图”时应修改<code>indicatorHolder</code>的中心的纵坐标。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="keyword">if</span> (mIndicatorOrientation == INDICATOR_ORIENTATION_VERTICAL) <span class="comment">//纵向</span></div><div class="line">                        indicatorHolder.setCenterY(end);</div><div class="line">...</div></pre></td></tr></table></figure></p>
<center>代码修改已同步到Github，你可以在这里下载到源代码：</center><br><center><a href="https://github.com/DuanJiaNing/IndicatorView" target="_blank" rel="external">DuanJiaNing/IndicatorView</a></center>

<hr>
<p><font color="#afafaf" size="-1">觉得不错的话就给颗星吧&gt;.&lt;</font></p>
<center><u><b><em>END</em></b></u></center>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/05/03/Android-Activity-的启动模式和标记位/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="James Duan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Duan">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/03/Android-Activity-的启动模式和标记位/" itemprop="url">Activity 的启动模式和标记位</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-03T13:59:11+08:00">
                2017-05-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="android-Activity-的启动模式和标记位"><a href="#android-Activity-的启动模式和标记位" class="headerlink" title="android-Activity 的启动模式和标记位"></a>android-Activity 的启动模式和标记位</h3><h5 id="Activity-启动过程涉及到的几个概念"><a href="#Activity-启动过程涉及到的几个概念" class="headerlink" title="Activity 启动过程涉及到的几个概念"></a>Activity 启动过程涉及到的几个概念</h5><blockquote>
<p>任务栈：</p>
</blockquote>
<p>任务栈又称 Task，顾名思义使用的是 <strong>栈</strong> 结构，具有先进后出的特点，栈中存放的是 Activity 组件的实例，我们每次启动一个 Activity （该 Activity 的 onCreate 方法将首次被调用），该 Activity 将被压入启动它的 Activity 所在的任务栈，或通过 Intent 指定<code>addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)</code>在新的任务栈中创建该 Activity。任务栈有前台和后台之分，后台任务栈中的 Activity 处于暂停状态，用户可以通过切换应用（<em>Activity</em>）将后台任务栈调到前台。</p>
<p>####Activity 的 LaunchMode</p>
<ol>
<li>standard 标准模式：<br>标准模式为系统默认启动模式。在该模式下每次启动 Activity 都会重新创建一个新的实例，不管这个实例是否已经存在。在这种模式下，谁启动了这个 Activity ，那么这个 Activity 就运行在启动它的那个 Activity 所在的任务栈中。</li>
<li>singleTop 栈顶复用模式：</li>
</ol>
<ul>
<li>在这种模式下，如果新 Activity 已经位于任务栈的栈顶，那么此 Activity 不会被重新创建    。</li>
<li>如果新 Activity 的实例已存在但不位于栈顶，那么新的 Activity 任会重新。</li>
<li>onNewIntent 方法会被回调。</li>
</ul>
<ol>
<li><p>singleTask 栈内复用模式：<br>在这种模式下，只要 Activity 在一个栈中存在，那么多次启动该 Activity 都不会重新创建实例，同时系统会回调其 onNewIntent 方法。可以分为如下三种情况进行区分：</p>
<ul>
<li>要启动的 Activity A 所需的任务栈 S 不存在：<br>系统先创建任务栈 S ，然后创建 A 并入栈到 S。</li>
<li>要启动的 Activity A 所需的任务栈 S 存在，且任务栈 S 中不存在 A 的实例：<br>系统将创建 A 的实例并入栈到 S。</li>
<li>要启动的 Activity A 所需的任务栈 S 存在，且任务栈 S 中存在 A 的实例 ：<ol>
<li>实例 A 位于栈顶：<br>直接复用（<em>栈顶复用</em>） </li>
<li>实例 A 不位于栈顶：<br>此时 A 不会重新创建，同时将实例 A 切换到栈顶（<em>使实例 A 上面的所有 Activity 出栈</em>）     </li>
</ol>
</li>
</ul>
</li>
<li>singleInstance 单实例模式：<br>这是一种加强的 singleTask 模式，它具有 singleTask 的所有特性之外还有一个特性，那就是具有此种启动模式的 Activity 只能单独位于一个任务栈中。 </li>
</ol>
<h4 id="Activity-的-Flags"><a href="#Activity-的-Flags" class="headerlink" title="Activity 的 Flags"></a>Activity 的 Flags</h4><p>Activity 的 Flags 有很多，标记位的作用有很多，有的标记位可以设定 Activity 的启动模式，有的可以影响 Activity 的运行状态。</p>
<ul>
<li>FLAG_ACTIVITY_NEW_TASK<br>指定 Activity 以 singleTask 模式启动</li>
<li>FLAG_ACTIVITY_SINGLE_TOP<br>指定 Activity 以 singleTop 模式启动</li>
<li>FLAG_ACTIVITY_CLEAR_TOP<br>具备此标记为的 Activity 在启动时会将位于同一任务栈的所有位于它上面的 Activity 出栈，这个标记位一般会和 singleTask一起出现，singleTask 启动模式默认就具有此标记位的效果</li>
<li>FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS<br>具有这个标记的 Activity 不会出现在历史 Activity 列表中。</li>
</ul>
<center><u><b><em>END</em></b></u></center>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/10/网易2017春招笔试真题编程题集合——2.优雅的点/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="James Duan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Duan">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/10/网易2017春招笔试真题编程题集合——2.优雅的点/" itemprop="url">网易2017春招笔试真题编程题集合 —— 2.优雅的点</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-10T16:44:11+08:00">
                2017-04-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="网易2017春招笔试真题编程题集合——2-优雅的点"><a href="#网易2017春招笔试真题编程题集合——2-优雅的点" class="headerlink" title="网易2017春招笔试真题编程题集合——2.优雅的点"></a>网易2017春招笔试真题编程题集合——<strong>2.优雅的点</strong></h3><p>原题地址在这里：<a href="https://www.nowcoder.com/question/next?pid=4575457&amp;qid=83061&amp;tid=7519540" target="_blank" rel="external">牛客网</a></p>
<h4 id="题目是这样的："><a href="#题目是这样的：" class="headerlink" title="题目是这样的："></a>题目是这样的：</h4><blockquote>
<p>小易有一个圆心在坐标原点的圆，小易知道圆的半径的平方。小易认为在圆上的点而且横纵坐标都是整数的点是优雅的，小易现在想寻找一个算法计算出优雅的点的个数，请你来帮帮他。<br>例如：半径的平方如果为25<br>优雅的点就有：(+/-3, +/-4), (+/-4, +/-3), (0, +/-5) (+/-5, 0)，一共12个点。 </p>
</blockquote>
<p>输入描述：</p>
<blockquote>
<p>输入为一个整数，即为圆半径的平方,范围在32位int范围内。</p>
</blockquote>
<p>输出描述：</p>
<blockquote>
<p>输出为一个整数，即为优雅的点的个数</p>
</blockquote>
<p>输入例子：</p>
<blockquote>
<p>25</p>
</blockquote>
<p>输出例子</p>
<blockquote>
<p>12</p>
</blockquote>
<h4 id="用java编写，思路是这样的："><a href="#用java编写，思路是这样的：" class="headerlink" title="用java编写，思路是这样的："></a>用java编写，思路是这样的：</h4><p>1 使用<code>java.util.Scanner</code>接收控制台输入<br>2 定义三个变量<code>int in,count = 0;double radius</code>；in 用于接收输入的圆的半径的平方，count 计录优雅点的个数，radius 为开平方后得到的半径<br>3 用变量 <code>int x</code> 遍历 0 到 radius 间的整数，x 作为横坐标求出对应的纵坐标 y，判断纵坐标是否为整数（小数位全为0）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Scanner;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</div><div class="line">        <span class="keyword">int</span> in = scanner.nextInt();</div><div class="line">        <span class="keyword">double</span> radius = Math.sqrt(in);</div><div class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt;= radius; x++) &#123;</div><div class="line">            <span class="keyword">double</span> y = Math.sqrt(in - x * x);</div><div class="line"><span class="comment">//            System.out.println("(" + x + "," + y + ")");</span></div><div class="line">            <span class="keyword">if</span> (y % <span class="number">1.0</span> == <span class="number">0</span>) &#123;</div><div class="line">                count++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println(radius % <span class="number">1.0</span> == <span class="number">0</span> ? count * <span class="number">4</span> - <span class="number">4</span> : count * <span class="number">4</span> + <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><em>提交运行</em> 之后就会提示通过所有测试用例：<br><img src="http://img.blog.csdn.net/20170410164323047?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYWltZWltZWlUUw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h4 id="注意点："><a href="#注意点：" class="headerlink" title="注意点："></a>注意点：</h4><ul>
<li>使用 Math.sqrt(double d) 求平方根</li>
<li>半径 radius 要用 double 型保存，因为 最后通过判断半径是否为整数决定要不要保留圆上与横纵坐标的四个交点</li>
<li>判断一个 double 型变量是否为整数 <code>number % 1.0 == 0</code></li>
</ul>
<center><u><b><em>END</em></b></u></center>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/04/06/Android-自定义View和属性动画ValueAnimator实现圆点指示器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="James Duan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Duan">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/04/06/Android-自定义View和属性动画ValueAnimator实现圆点指示器/" itemprop="url">Android：自定义View和属性动画ValueAnimator实现圆点指示器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-06T01:04:11+08:00">
                2017-04-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="自定义View和属性动画ValueAnimator实现圆点指示器"><a href="#自定义View和属性动画ValueAnimator实现圆点指示器" class="headerlink" title="自定义View和属性动画ValueAnimator实现圆点指示器"></a>自定义View和属性动画ValueAnimator实现圆点指示器</h3><blockquote>
<p><strong>自定义View和属性动画相结合实现支持动态修改指示点位置，拖拽或点击改变指示点位置，点击位置监听及切换动画自定义的圆点指示器。</strong></p>
</blockquote>
<h4 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h4><p><img src="http://img.blog.csdn.net/20170406005647275?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYWltZWltZWlUUw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<font size="2" color="#a8a8a8">最下面那个“吸干”，想不出用什么词形容更好&gt;.&lt;，后来改回”挤扁”</font>

<p>自定 View 代码写在 <code>IndicatorView.java</code>中</p>
<h4 id="IndicatorView由以下几个重要的图形构成"><a href="#IndicatorView由以下几个重要的图形构成" class="headerlink" title="IndicatorView由以下几个重要的图形构成"></a>IndicatorView由以下几个重要的图形构成</h4><ul>
<li>小圆点：固定不动的圆形</li>
<li>指示点：在小圆点上来回移动，通过改变指示点当前所在位置来实现 <code>指示器</code> 的功能，为了实现“挤扁”的动画效果，绘制时用的是椭圆。</li>
<li>线段：用于连接两个小圆点，绘制时以两个相邻小圆点间的距离为一个 <code>线段</code> 单位。循环绘制 <code>线段</code> ，绘制<code>小圆点个数减一</code> 次后连通所有小圆点，<em>在布局文件或代码中可修改其可见性（<code>lineVisible</code>）</em><br><img src="http://img.blog.csdn.net/20170406005737300?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYWltZWltZWlUUw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"><h4 id="实现的功能："><a href="#实现的功能：" class="headerlink" title="实现的功能："></a>实现的功能：</h4></li>
<li>支持通过xml定义IndicatorView的属性<ul>
<li>属性包括：<br>1 指示点大小、颜色<br>2 固定显示的小圆点的大小、颜色以及数量<br>3 连接小圆点的线条的可见性，线条宽度、长度、颜色<br>4 默认提供了两个用于指示点间切换的动画（平移和挤扁），也可选择不使用动画或自定义<br>5 默认提供的切换动画的时间可指定<br>6 启用/禁用拖拽切换（点击切换或两者）功能</li>
</ul>
</li>
<li>通过代码动态修改部分属性</li>
<li>通过代码或得属性值，如当前指示点位置，颜色等</li>
<li>通过代码自定义指示点间切换动画，指示点被触摸的反馈动画及点击事件监听的回调</li>
</ul>
<h4 id="属性定义在src-main-res-values-attrs-xml文件中。"><a href="#属性定义在src-main-res-values-attrs-xml文件中。" class="headerlink" title="属性定义在src/main/res/values/attrs.xml文件中。"></a>属性定义在<code>src/main/res/values/attrs.xml</code>文件中。</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"lineColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span> <span class="comment">&lt;!--线条颜色 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"lineVisible"</span> <span class="attr">format</span>=<span class="string">"boolean"</span> /&gt;</span> <span class="comment">&lt;!--线条是否可见 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"lineWidth"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span> <span class="comment">&lt;!--线条长度 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"lineHeight"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span> <span class="comment">&lt;!--线条高度 --&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"dotSize"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span> <span class="comment">&lt;!--小圆点大小 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"dotNum"</span> <span class="attr">format</span>=<span class="string">"integer"</span>/&gt;</span> <span class="comment">&lt;!--小圆点个数 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"dotColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span> <span class="comment">&lt;!--小圆点颜色 --&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"indicatorColor"</span> <span class="attr">format</span>=<span class="string">"color"</span> /&gt;</span> <span class="comment">&lt;!--指示点颜色 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"indicatorSize"</span> <span class="attr">format</span>=<span class="string">"dimension"</span> /&gt;</span> <span class="comment">&lt;!--指示点大小 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"indicatorPos"</span> <span class="attr">format</span>=<span class="string">"integer"</span>/&gt;</span> <span class="comment">&lt;!--指示点位置 --&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"duration"</span> <span class="attr">format</span>=<span class="string">"integer"</span>/&gt;</span> <span class="comment">&lt;!--两点间移动动画时间 --&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"dotClickEnable"</span> <span class="attr">format</span>=<span class="string">"boolean"</span>/&gt;</span><span class="comment">&lt;!--小圆点点点击时是否把指示点移到点击的小圆点处，若置为false则只能通过setIndicatorPos()方法改变指示点位置--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"indicatorDragEnable"</span> <span class="attr">format</span>=<span class="string">"boolean"</span>/&gt;</span><span class="comment">&lt;!--指示点拖拽是否可用--&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"touchEnable"</span> <span class="attr">format</span>=<span class="string">"boolean"</span>/&gt;</span><span class="comment">&lt;!--同时禁用小圆点点击和指示点拖拽--&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"IndicatorSwitchAnimation"</span> <span class="attr">format</span>=<span class="string">"integer"</span>&gt;</span> <span class="comment">&lt;!--使用默认提供的动画--&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">"translation"</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span> <span class="comment">&lt;!--平移--&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">"squeeze"</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span><span class="comment">&lt;!--"挤扁"--&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">enum</span> <span class="attr">name</span>=<span class="string">"none"</span> <span class="attr">value</span>=<span class="string">"0"</span>/&gt;</span> <span class="comment">&lt;!--不使用动画--&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">attr</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"IndicatorView"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"dotColor"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"dotSize"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"dotNum"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"lineColor"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"lineVisible"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"lineWidth"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"lineHeight"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"indicatorColor"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"indicatorSize"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"indicatorPos"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"duration"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"IndicatorSwitchAnimation"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"dotClickEnable"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"indicatorDragEnable"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"touchEnable"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure>
<p>可以在布局文件中直接使用：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">com.duan.indicatorviewdemo.IndicatorView</span></span></div><div class="line">     <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">     <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line"></div><div class="line">     <span class="attr">app:IndicatorSwitchAnimation</span>=<span class="string">"squeeze"</span></div><div class="line">     <span class="attr">app:dotColor</span>=<span class="string">"#2d2b2b"</span></div><div class="line">     <span class="attr">app:dotNum</span>=<span class="string">"4"</span></div><div class="line">     <span class="attr">app:dotSize</span>=<span class="string">"10dp"</span></div><div class="line">     <span class="attr">app:duration</span>=<span class="string">"800"</span></div><div class="line">     <span class="attr">app:indicatorColor</span>=<span class="string">"#ff9500"</span></div><div class="line">     <span class="attr">app:indicatorPos</span>=<span class="string">"1"</span></div><div class="line"></div><div class="line">     <span class="attr">app:indicatorSize</span>=<span class="string">"25dp"</span></div><div class="line">     <span class="attr">app:lineColor</span>=<span class="string">"#b3b3b3"</span></div><div class="line">     <span class="attr">app:lineHeight</span>=<span class="string">"4dp"</span></div><div class="line">     <span class="attr">app:lineWidth</span>=<span class="string">"85dp"</span> /&gt;</div></pre></td></tr></table></figure>
<h4 id="来看下实现代码吧（IndicatorView-java）"><a href="#来看下实现代码吧（IndicatorView-java）" class="headerlink" title="来看下实现代码吧（IndicatorView.java）"></a>来看下实现代码吧（IndicatorView.java）</h4><h5 id="几个重要的变量的作用要先了解一下："><a href="#几个重要的变量的作用要先了解一下：" class="headerlink" title="几个重要的变量的作用要先了解一下："></a>几个重要的变量的作用要先了解一下：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">...........</div><div class="line"><span class="comment">/**</span></div><div class="line">    * 保存所有小圆点的圆点坐标，用于在touch事件中判断触摸了哪个点</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">int</span>[][] clickableAreas;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 指示点，不断修改它的属性从而实现动画（属性动画）</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> IndicatorHolder indicatorHolder;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 指示点要移动到的目标位置</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">int</span> switchTo = -<span class="number">1</span>;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 手松开后根据该变量判断是否需要启动切换动画</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> haveIndicatorAniming = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 指示点是否被拖拽过，当指示点被拖拽了但没有超过当前指示点位置范围时使之回到原位</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">boolean</span> haveIndicatorDraged = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 保存转移动画开始时线的颜色</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">int</span> tempLineColor;</div><div class="line">   .........</div></pre></td></tr></table></figure>
<h5 id="onMeasure方法"><a href="#onMeasure方法" class="headerlink" title="onMeasure方法"></a>onMeasure方法</h5><ul>
<li>在 onMeasure 方法中要把自定义 view 的宽和高计算出来。</li>
<li>如果在 xml 中指定具体的宽高值或为 match_parent 时不做计算，因为此时宽高就是指定的值或是填满父布局后的宽高。</li>
<li>当 xml 中宽高设为 warp_content 时需要进行计算<ul>
<li>计算宽度的规则：左右的内边距 + 所有 <code>线段</code> 加起来的总长度</li>
<li>计算高度的规则：上下内边距 + <code>指示点</code> 的高度。注意：使用默认的 <code>指示点</code> 触摸反馈动画时要加上高度差</li>
</ul>
</li>
<li><code>setPadding(getPaddingLeft() + mIndicatorSize / 3......</code>这一句是为了在使用默认的 <code>指示点</code> 触摸反馈动画，或是自定义动画中有使指示点放大的情况下要多留些空间给控件，否则 <code>指示点</code>放大后超出控件高度的部分就不会被绘制（不会显示）。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</div><div class="line">        <span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec);</div><div class="line">        <span class="keyword">int</span> heightMode = MeasureSpec.getMode(heightMeasureSpec);</div><div class="line">        <span class="keyword">int</span> heightSize = MeasureSpec.getSize(heightMeasureSpec);</div><div class="line">        <span class="keyword">int</span> width;</div><div class="line">        <span class="keyword">int</span> height;</div><div class="line">        setPadding(getPaddingLeft() + mIndicatorSize / <span class="number">3</span>,getPaddingTop(),getPaddingRight() + mIndicatorSize / <span class="number">3</span>,getPaddingBottom());</div><div class="line">        <span class="keyword">if</span> (widthMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">            width = widthSize;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//xml中宽度设为warp_content</span></div><div class="line">            width = getPaddingLeft() + ((mDotCount - <span class="number">1</span>) * mLineWidth + mIndicatorSize) + getPaddingRight();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (heightMode == MeasureSpec.EXACTLY) &#123;</div><div class="line">            height = heightSize;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            height = getPaddingTop() + mIndicatorSize + getPaddingBottom();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//若使用默认的指示点触摸动画（放大+渐变颜色）需要加上放大后指示点与放大前指示点的高度差</span></div><div class="line">        <span class="comment">//使用自定义时动画时则不加</span></div><div class="line">        setMeasuredDimension(width, mPressAnimator == <span class="keyword">null</span> ? height + mIndicatorSize / <span class="number">2</span> : height);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="onLayout方法"><a href="#onLayout方法" class="headerlink" title="onLayout方法"></a>onLayout方法</h5><p>在onLayout方法中要对 <code>indicatorHolder</code>变量进行初始化。</p>
<h6 id="关于-indicatorHolder变量：private-IndicatorHolder-indicatorHolder"><a href="#关于-indicatorHolder变量：private-IndicatorHolder-indicatorHolder" class="headerlink" title="关于 indicatorHolder变量：private IndicatorHolder indicatorHolder;"></a>关于 <code>indicatorHolder</code>变量：<code>private IndicatorHolder indicatorHolder;</code></h6><ul>
<li><code>IndicatorHolder</code> 类的实例 <code>indicatorHolder</code> 即为属性对象的<code>target</code>，控件默认定义好了三个属性动画：<ul>
<li>颜色渐变+缩放：<code>指示点</code> 的触摸反馈</li>
<li>平移+压扁+拉伸：<code>指示点</code> 切换</li>
<li>平移： <code>指示点</code> 切换</li>
</ul>
</li>
<li>自定义动画也限定只能将<code>indicatorHolder</code>作为属性动画的target来实现动画</li>
</ul>
<blockquote>
<p>上面三个动画都是通过不断修改<code>indicatorHolder</code> 的属性（调用<code>indicatorHolder</code> 的 setXXX() 而 setXXX()方法中会调用 invalidate() 重绘 view）实现动画的。具体可参见：<a href="http://blog.csdn.net/jdsjlzx/article/details/45558901" target="_blank" rel="external">ValueAnimator和ObjectAnimator的高级用法</a></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndicatorHolder</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> centerX;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> centerY;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> height;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> color;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> width;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">int</span> alpha;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAlpha</span><span class="params">(<span class="keyword">int</span> alpha)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.alpha = alpha;</div><div class="line">            invalidate();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAlpha</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> alpha;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHeight</span><span class="params">(<span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.height = height;</div><div class="line">            invalidate();</div><div class="line">        &#125;</div><div class="line">        ...........</div></pre></td></tr></table></figure>
<p><br></p>
<ul>
<li>注意 getHeight 方法在 onMeasure 中调用的话获取到的值是不正确的，因为此时视图的高和宽还在计算。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onLayout(changed, left, top, right, bottom);</div><div class="line">    <span class="comment">//getHeight方法在onDraw方法中会取到错误的值</span></div><div class="line">    <span class="keyword">if</span> (indicatorHolder != <span class="keyword">null</span>) &#123;</div><div class="line">        indicatorHolder.setColor(mIndicatorColor);</div><div class="line">        indicatorHolder.setCenterX(mIndicatorPos * mLineWidth + getPaddingLeft() + mIndicatorSize / <span class="number">2</span>);</div><div class="line">        indicatorHolder.setCenterY(getHeight() / <span class="number">2</span>);</div><div class="line">        indicatorHolder.setHeight(mIndicatorSize);</div><div class="line">        indicatorHolder.setWidth(mIndicatorSize);</div><div class="line">        indicatorHolder.setAlpha(<span class="number">255</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="onDraw-方法"><a href="#onDraw-方法" class="headerlink" title="onDraw()方法"></a><strong><code>onDraw()</code>方法</strong></h5><p>绘制控件的关键方法<br><br>1 控件中包含多个圆，使画笔支持抗锯齿使视觉效果更好 <code>setAntiAlias(true)</code><br>2 画线的时候先判断是否设置了 <code>线段不可见</code> 属性<br>3 画 <code>小圆点</code> ，关键的一句 <code>if (switchTo != -1 &amp;&amp; i == switchTo)</code>：</p>
<ul>
<li>switchTo 的值默认为 -1 ，在 onTouchEvent 事件中会为其赋值，当 <code>小圆点</code> 被点击或 <code>指示点</code> 被拖拽<ul>
<li><code>同时被点击小圆点的位置与当前正在绘制的小圆点的位置相同</code> 或</li>
<li><code>指示点拖拽时指示点中心点（椭圆外切矩形对角线交点）所在区域（由 clickableAreas 规定的区域）  与 当前正在绘制的小圆点的位置相同</code>  时该 if 才为 true</li>
</ul>
</li>
<li>switchTo 会在 <code>animEnd()</code> 方法中被重置为 -1</li>
<li>话小圆点时为 <code>clickableAreas</code> 赋值，记录当前小圆点的圆心坐标</li>
</ul>
<p>4 画指示点：</p>
<ul>
<li>通过调用 <code>indicatorHolder</code> 的 <code>getXXX()</code>方法获得指示点的当前形态进行绘制</li>
<li>属性动画在调用了 <code>start()</code>之后会不断调用 <code>indicatorHolder</code> 的 <code>setXXX()</code>方法，同时调用 <code>invalidate</code>方法，<code>onDraw(...)</code>方法就会被不断调用，视图不断刷新，指示点、小圆点以及线段的形态就会不断改变，动画就形成了。<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDraw(canvas);</div><div class="line"></div><div class="line">    <span class="comment">//去锯齿</span></div><div class="line">    mPaint.setAntiAlias(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">//画线（如果可见）</span></div><div class="line">    <span class="keyword">if</span> (mLineVisible) &#123;</div><div class="line">        mPaint.setColor(mLineColor);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mDotCount - <span class="number">1</span>; i++) &#123;</div><div class="line">            <span class="keyword">int</span> left = getPaddingLeft() + mIndicatorSize / <span class="number">2</span> + mLineWidth * i;</div><div class="line">            <span class="keyword">int</span> top = (getHeight() - mLineHeight) / <span class="number">2</span>;</div><div class="line">            <span class="keyword">int</span> right = getPaddingLeft() + mIndicatorSize / <span class="number">2</span> + mLineWidth * (i + <span class="number">1</span>);</div><div class="line">            <span class="keyword">int</span> bottom = (getHeight() + mLineHeight) / <span class="number">2</span>;</div><div class="line">            canvas.drawRect(left, top, right, bottom, mPaint);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//画小圆点</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; clickableAreas.length; i++) &#123;</div><div class="line">        <span class="keyword">int</span> cx = i * mLineWidth + getPaddingLeft() + mIndicatorSize / <span class="number">2</span>;</div><div class="line">        <span class="keyword">int</span> cy = getHeight() / <span class="number">2</span>;</div><div class="line">        <span class="keyword">if</span> (switchTo != -<span class="number">1</span> &amp;&amp; i == switchTo)</div><div class="line">            mPaint.setColor(mIndicatorColor);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            mPaint.setColor(mDotColor);</div><div class="line">        canvas.drawCircle(cx, cy, mDotSize, mPaint);</div><div class="line">        clickableAreas[i][<span class="number">0</span>] = cx;</div><div class="line">        clickableAreas[i][<span class="number">1</span>] = cy;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//画指示点</span></div><div class="line">    mPaint.setColor(indicatorHolder.getColor());</div><div class="line">    mPaint.setAlpha(indicatorHolder.getAlpha());</div><div class="line">    canvas.drawOval(</div><div class="line">            indicatorHolder.getCenterX() - indicatorHolder.getWidth() / <span class="number">2</span>,</div><div class="line">            indicatorHolder.getCenterY() - indicatorHolder.getHeight() / <span class="number">2</span>,</div><div class="line">            indicatorHolder.getCenterX() + indicatorHolder.getWidth() / <span class="number">2</span>,</div><div class="line">            indicatorHolder.getCenterY() + indicatorHolder.getHeight() / <span class="number">2</span>,</div><div class="line">            mPaint</div><div class="line">    );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="最后一个关键方法-onTouchEvent"><a href="#最后一个关键方法-onTouchEvent" class="headerlink" title="最后一个关键方法 onTouchEvent"></a>最后一个关键方法 <code>onTouchEvent</code></h5><p>1 <code>touchEnable</code>属性设为 false 则不需要响应触摸事件<br>2 动画正在进行时不再响应触摸事件，否则会乱套…..<br>3 <code>if (switchTo != mIndicatorPos &amp;&amp; !mDotClickEnable &amp;&amp; !haveIndicatorDraged)</code> ：</p>
<ul>
<li>点击了非指示点所在的小圆点 &amp;&amp; 不可点击 &amp;&amp; 指示点没有被拖拽：脑补一下这种情形就是——当你设置了不可点击（点击非指示点所在小圆点时不移动指示点到所点击的小圆点的位置上），但你点击了，而且点击的不是指示点所在的小圆点。此时就不要移动指示点了，因为设置了 不可点击嘛。</li>
<li>有没有疑惑为什么要加一个 <code>&amp;&amp; !haveIndicatorDraged</code>的条件？往下看…</li>
<li>之所以要加这个判断是当你设置了 <code>不可点击</code>，<code>可拖拽</code> 时，当你开始拖拽，而且拖拽位置超出当前指示点范围（<code>clickableAreas</code>规定的范围），假设此时如果只判断 <code>switchTo != mIndicatorPos &amp;&amp; !mDotClickEnable</code>，那么此时这两条件都满足，返回。那此时效果就是指示点不能拖出<code>clickableAreas</code>规定的范围，显然不满足 <code>不可点击</code>，但<code>可拖拽</code>的要求，所有还要加一个 <code>是否被拖拽过的条件</code>。</li>
</ul>
<p>4 接下来依次判断手势状态</p>
<ul>
<li>按下：按在指示点上还是其他小圆点上</li>
<li>抬起：按下的点不是当前指示点所在小圆点（按下后立刻抬起），或被拖拽过</li>
<li>挤压：手指一直与屏幕接触，这个时候就是拖拽了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (!mTouchEnable)</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"></div><div class="line">       <span class="comment">//动画正在进行时不在响应点击事件</span></div><div class="line">       <span class="keyword">if</span> (haveIndicatorAniming)</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"></div><div class="line">       <span class="keyword">int</span> ex = (<span class="keyword">int</span>) event.getX();</div><div class="line">       <span class="keyword">int</span> temp = mLineWidth / <span class="number">2</span>;</div><div class="line">       switchTo = <span class="number">0</span>;</div><div class="line">       <span class="comment">//判断当前手指所在的小圆点是哪个</span></div><div class="line">       <span class="keyword">for</span> (; switchTo &lt; mDotCount; switchTo++) &#123;</div><div class="line">           <span class="keyword">int</span>[] xy = clickableAreas[switchTo];</div><div class="line">           <span class="comment">//只对x坐标位置进行判断，这样即使用户手指在控件外面（先在控件内触摸后不抬起而是滑到控件外面）滑动也能判断</span></div><div class="line">           <span class="keyword">if</span> (ex &lt;= xy[<span class="number">0</span>] + temp &amp;&amp; ex &gt;= xy[<span class="number">0</span>] - temp) &#123;</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (switchTo != mIndicatorPos &amp;&amp; !mDotClickEnable &amp;&amp; !haveIndicatorDraged)</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (event.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">           <span class="comment">//按下且不是指示点所在的小圆点</span></div><div class="line">           <span class="keyword">if</span> (mIndicatorPos != switchTo) &#123;</div><div class="line">               startSwitchAnimation();</div><div class="line">               <span class="keyword">if</span> (mListener != <span class="keyword">null</span>)</div><div class="line">                   mListener.onDotClickChange(<span class="keyword">this</span>, switchTo);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;<span class="comment">//按下且是指示点所在的小圆点</span></div><div class="line">               <span class="keyword">if</span> (mIndicatorDragEnable)</div><div class="line">                   startPressAnimation();</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getAction() == MotionEvent.ACTION_UP) &#123; <span class="comment">//手抬起</span></div><div class="line">           <span class="keyword">if</span> (switchTo != mIndicatorPos || haveIndicatorDraged) &#123;</div><div class="line">               haveIndicatorDraged = <span class="keyword">false</span>;</div><div class="line">               <span class="keyword">if</span> (mIndicatorDragEnable)</div><div class="line">                   startSwitchAnimation();</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123; <span class="comment">//按着+拖拽</span></div><div class="line">           <span class="keyword">if</span> (mIndicatorDragEnable) &#123;</div><div class="line">               haveIndicatorDraged = <span class="keyword">true</span>;</div><div class="line">               indicatorHolder.setCenterX(ex);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h5 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h5><blockquote>
<p>代码有些多又繁琐就没贴完，上传到GitHub了，可以在这里下载到源码和示例：<a href="https://github.com/DuanJiaNing/IndicatorViewDemo" target="_blank" rel="external">DuanJiaNing/IndicatorViewDemo</a></p>
</blockquote>
<ul>
<li>开始指示点触摸（挤压）动画：<code>startPressAnimation()</code></li>
<li>开始指示点切换动画： <code>startSwitchAnimation()</code></li>
<li>指示点切换动画结束或取消时重置和恢复一些变量的值：<code>animEnd()</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * 指示点触摸（挤压）动画</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startPressAnimation</span><span class="params">()</span> </span>&#123;</div><div class="line">		........</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 指示点切换动画</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startSwitchAnimation</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//平移</span></div><div class="line">        <span class="keyword">int</span> startX = indicatorHolder.getCenterX();</div><div class="line">        <span class="keyword">int</span> endX = switchTo * mLineWidth + getPaddingLeft() + mIndicatorSize / <span class="number">2</span>;</div><div class="line">        ValueAnimator trainsAnim = ObjectAnimator.ofInt(indicatorHolder, <span class="string">"centerX"</span>, startX, endX);</div><div class="line">        trainsAnim.setDuration(mDuration);</div><div class="line"></div><div class="line">        tempLineColor = mLineColor;</div><div class="line">        AnimatorSet defaultIndicatorSwitchAnim = <span class="keyword">new</span> AnimatorSet();</div><div class="line">        defaultIndicatorSwitchAnim.addListener(<span class="keyword">new</span> Animator.AnimatorListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                mLineColor = indicatorHolder.getColor();</div><div class="line">                haveIndicatorAniming = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                animEnd();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                animEnd();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationRepeat</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mSwitchAnimator == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">switch</span> (mIndicatorSwitchAnim) &#123;</div><div class="line">                <span class="keyword">case</span> INDICATOR_SWITCH_ANIM_NONE:</div><div class="line">                    indicatorHolder.setCenterX(endX);</div><div class="line">                    animEnd();</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDICATOR_SWITCH_ANIM_SQUEEZE:</div><div class="line">                    <span class="comment">//“挤扁”</span></div><div class="line">                    <span class="keyword">int</span> centerH = mLineHeight * Math.abs(switchTo - mIndicatorPos);</div><div class="line">                    <span class="keyword">int</span> centerW = Math.abs(indicatorHolder.getCenterX() - clickableAreas[switchTo][<span class="number">0</span>]);</div><div class="line">                    ValueAnimator heightAnim = ObjectAnimator.ofInt(indicatorHolder, <span class="string">"height"</span>, mIndicatorSize, centerH, <span class="number">0</span>);</div><div class="line">                    ValueAnimator widthAnim = ObjectAnimator.ofInt(indicatorHolder, <span class="string">"width"</span>, mIndicatorSize, centerW, <span class="number">0</span>);</div><div class="line">                    heightAnim.setDuration(mDuration);</div><div class="line">                    widthAnim.setDuration(mDuration);</div><div class="line"></div><div class="line">                    <span class="comment">//缩放</span></div><div class="line">                    ValueAnimator scaleAnimH = ObjectAnimator.ofInt(indicatorHolder, <span class="string">"height"</span>, mDotSize, mIndicatorSize);</div><div class="line">                    ValueAnimator scaleAnimW = ObjectAnimator.ofInt(indicatorHolder, <span class="string">"width"</span>, mDotSize, mIndicatorSize);</div><div class="line">                    AnimatorSet scaleSet = <span class="keyword">new</span> AnimatorSet();</div><div class="line">                    scaleSet.play(scaleAnimH).with(scaleAnimW);</div><div class="line">                    scaleSet.setDuration(<span class="number">500</span>);</div><div class="line"></div><div class="line">                    defaultIndicatorSwitchAnim.play(trainsAnim).with(heightAnim).with(widthAnim);</div><div class="line">                    defaultIndicatorSwitchAnim.play(scaleSet).after(trainsAnim);</div><div class="line">                    defaultIndicatorSwitchAnim.start();</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDICATOR_SWITCH_ANIM_TRANSLATION:</div><div class="line">                    defaultIndicatorSwitchAnim.play(trainsAnim);</div><div class="line">                    defaultIndicatorSwitchAnim.start();</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">//自定义</span></div><div class="line">            tempLineColor = mLineColor;</div><div class="line">            AnimatorSet customAnim = mSwitchAnimator.onIndicatorSwitch(<span class="keyword">this</span>, indicatorHolder);</div><div class="line">            customAnim.play(trainsAnim);</div><div class="line">            customAnim.addListener(<span class="keyword">new</span> Animator.AnimatorListener() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                    mLineColor = indicatorHolder.getColor();</div><div class="line">                    haveIndicatorAniming = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                    animEnd();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationCancel</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line">                    animEnd();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationRepeat</span><span class="params">(Animator animation)</span> </span>&#123;</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">            customAnim.start();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 指示点切换动画结束或取消时重置和恢复一些变量的值</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">animEnd</span><span class="params">()</span> </span>&#123;</div><div class="line">        mLineColor = tempLineColor;</div><div class="line">        mIndicatorPos = switchTo;</div><div class="line">        switchTo = -<span class="number">1</span>;</div><div class="line">        haveIndicatorAniming = <span class="keyword">false</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h5 id="在Activity中设置自定义动画和点击事件监听以及一些属性的修改和获取"><a href="#在Activity中设置自定义动画和点击事件监听以及一些属性的修改和获取" class="headerlink" title="在Activity中设置自定义动画和点击事件监听以及一些属性的修改和获取"></a>在Activity中设置自定义动画和点击事件监听以及一些属性的修改和获取</h5><p><a href="https://github.com/DuanJiaNing/IndicatorViewDemo" target="_blank" rel="external">DuanJiaNing/IndicatorViewDemo</a> 中示例Activity的位置：<br><code>\src\main\java\com\duan\indicatorviewdemo\MainActivity.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> IndicatorView indicator;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        indicator = (IndicatorView) findViewById(R.id.indicator);</div><div class="line">        </div><div class="line">        indicator.setOnDotClickListener((View v, <span class="keyword">int</span> position) -&gt; Toast.makeText(<span class="keyword">this</span>, <span class="string">"点击了 "</span> + position, Toast.LENGTH_SHORT).show());</div><div class="line">        indicator.setOnIndicatorSwitchAnimator((IndicatorView view, IndicatorView.IndicatorHolder target) -&gt; &#123;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> terminalColor = indicator.getIndicatorColor();</div><div class="line">            <span class="keyword">int</span> centerColor = indicator.getDotColor();</div><div class="line">            ValueAnimator colorAnim = ObjectAnimator.ofArgb(target, <span class="string">"color"</span>, terminalColor, centerColor, terminalColor);</div><div class="line"></div><div class="line">            <span class="keyword">int</span> terminalSize = indicator.getIndicatorPixeSize();</div><div class="line">            <span class="keyword">int</span> centerSize = indicator.getIndicatorPixeSize() * <span class="number">3</span> / <span class="number">2</span>;</div><div class="line">            ValueAnimator animatorH = ObjectAnimator.ofInt(target, <span class="string">"height"</span>, terminalSize, centerSize, terminalSize);</div><div class="line">            ValueAnimator animatorW = ObjectAnimator.ofInt(target, <span class="string">"width"</span>, terminalSize, centerSize, terminalSize);</div><div class="line"></div><div class="line">            AnimatorSet set = <span class="keyword">new</span> AnimatorSet();</div><div class="line">            set.play(colorAnim).with(animatorH).with(animatorW);</div><div class="line">            set.setDuration(<span class="number">500</span>);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> set;</div><div class="line">        &#125;);</div><div class="line">        <span class="comment">//indicator1.setIndicatorSwitchAnim(random.nextInt(IndicatorView.INDICATOR_SWITCH_ANIM_TRANSLATION);</span></div><div class="line">        ...</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h5 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h5><ul>
<li>自定义属性的使用，在构造方法中用<code>context.getTheme().obtainStyledAttributes(...)</code>方法获取</li>
<li><code>onMeasure()</code>方法中对宽高的计算</li>
<li><code>onDraw</code>绘制圆、矩形、椭圆时坐标的确定</li>
<li>重写触摸事件时对各种状态的判断</li>
<li><code>animEnd</code>：动画结束或取消时重置和恢复一些变量的值</li>
<li>即使设置<code>lineVisible</code>为 false ，也要为<code>lineWidth</code>赋值，当然也可以使用默认的，因为<code>lineWidth</code>是<code>onMeasure</code>方法计算控件<code>width</code>的重要变量。</li>
<li>调用<code>setOnIndicatorSwitchAnimator</code>或<code>setOnIndicatorPressAnimator</code>自定义动画时，要将定义好的<code>AnimatorSet</code>动画作为返回值返回，由控件控制动画在何时播放和添加监听事件。</li>
</ul>
<hr>
<p>你可以为<code>IndicatorHodler</code>添加更多属性并修改<code>onDraw()</code>方法以实现更丰富的动画<br>源码和示例已上传GitHub，可以在这里下载到：<a href="https://github.com/DuanJiaNing/IndicatorViewDemo" target="_blank" rel="external">DuanJiaNing/IndicatorViewDemo</a></p>
<font size="2" color="#a8a8a8">觉得还不错的话就给颗star吧&gt;.&lt;</font>

<center><b><i>END</i></b> </center>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/29/网易2017春招笔试真题编程题集合——4.消除重复元素/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="James Duan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Duan">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/29/网易2017春招笔试真题编程题集合——4.消除重复元素/" itemprop="url">网易2017春招笔试真题编程题集合 —— 4.消除重复元素</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-29T13:41:11+08:00">
                2017-03-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>###网易2017春招笔试真题编程题集合——4.消除重复元素</p>
<h4 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h4><blockquote>
<p>小易有一个长度为n序列，小易想移除掉里面的重复元素，但是小易想是对于每种元素保留最后出现的那个。小易遇到了困难,希望你来帮助他。 </p>
</blockquote>
<p>原题地址 <a href="https://www.nowcoder.com/question/next?pid=4575457&amp;qid=83061&amp;tid=7519540" target="_blank" rel="external">在这</a></p>
<h4 id="输入描述"><a href="#输入描述" class="headerlink" title="输入描述:"></a>输入描述:</h4><blockquote>
<p>输入包括两行：<br>第一行为序列长度n(1 ≤ n ≤ 50)<br>第二行为n个数sequence<a href="1 ≤ sequence[i] ≤ 1000">i</a>，以空格分隔</p>
</blockquote>
<h4 id="输出描述"><a href="#输出描述" class="headerlink" title="输出描述:"></a>输出描述:</h4><blockquote>
<p>输出消除重复元素之后的序列，以空格分隔，行末无空格</p>
</blockquote>
<h4 id="输入例子"><a href="#输入例子" class="headerlink" title="输入例子:"></a>输入例子:</h4><blockquote>
<p>9<br>100 100 100 99 99 99 100 100 100</p>
</blockquote>
<h4 id="输出例子"><a href="#输出例子" class="headerlink" title="输出例子:"></a>输出例子:</h4><blockquote>
<p>99 100</p>
</blockquote>
<h4 id="用java编写，思路是这样的："><a href="#用java编写，思路是这样的：" class="headerlink" title="用java编写，思路是这样的："></a>用java编写，思路是这样的：</h4><ul>
<li>使用Scanner接收控制台输入</li>
<li>难点应该是要求中的<code>对于每种元素保留最后出现的那个</code>这一句：<ul>
<li>像出现如下情况时：100 100 99 11 11 11，移除重复元素必然是：100 99 11</li>
<li>而若出现这种情况：100 100 100 99 99 99 100 100 100，为满足 <code>对于每种元素保留最后出现的那个</code> 这一要求，三个99前后都出现了100，这时只能保留99后面的100，即 <code>99 100</code>；</li>
</ul>
</li>
<li>只需<strong>从后往前</strong>遍历给定的数组即可满足<code>对于每种元素保留最后出现的那个</code>这一要求，用一个<code>ArrayList</code>保存合并重复元素后的集合，每往前遍历一个元素先判断该元素是否已经存在集合中，不存在就添加到集合中。</li>
<li>遍历结束要将集合<strong>倒序</strong>输出，因为遍历的时候对目标数组的遍历是从后往前的，加入到集合的顺序也是从后往前的，而输出时应该<strong>从前往后</strong>输出。</li>
</ul>
<h4 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Scanner;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</div><div class="line">        <span class="keyword">int</span> count = scanner.nextInt();</div><div class="line">        scanner.nextLine();</div><div class="line">        String sou = scanner.nextLine();</div><div class="line">        String[] strs = sou.split(<span class="string">" "</span>);</div><div class="line">        <span class="keyword">int</span>[] nums = <span class="keyword">new</span> <span class="keyword">int</span>[count];</div><div class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (String s : strs) &#123;</div><div class="line">            nums[i++] = Integer.parseInt(s);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        i = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = nums.length - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</div><div class="line">            <span class="keyword">if</span> (!list.contains(nums[j]))</div><div class="line">                list.add(i++, nums[j]);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = list.size() - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</div><div class="line">            String out = j == <span class="number">0</span> ? list.get(j) + <span class="string">""</span> : list.get(j) + <span class="string">" "</span>;</div><div class="line">            System.out.print(out);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="提交运行提示通过所有测试用例："><a href="#提交运行提示通过所有测试用例：" class="headerlink" title="提交运行提示通过所有测试用例："></a>提交运行提示通过所有测试用例：</h4><p><img src="http://img.blog.csdn.net/20170329133939169?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYWltZWltZWlUUw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h4 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h4><ul>
<li>调用<code>Arraylist</code>的<code>boolean contains(Object o)</code>方法判断集合中是否已经包含某一元素一简化代码</li>
</ul>
<center><u><b><em>END</em></b></u></center>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/27/网易2017春招笔试真题编程题集合——9.涂棋盘/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="James Duan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Duan">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/27/网易2017春招笔试真题编程题集合——9.涂棋盘/" itemprop="url">网易2017春招笔试真题编程题集合 —— 9.涂棋盘</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-27T22:11:11+08:00">
                2017-03-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="网易2017春招笔试真题编程题集合——9-涂棋盘"><a href="#网易2017春招笔试真题编程题集合——9-涂棋盘" class="headerlink" title="网易2017春招笔试真题编程题集合——9.涂棋盘"></a>网易2017春招笔试真题编程题集合——<strong>9.涂棋盘</strong></h3><h4 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h4><blockquote>
<p>小易有一块n*n的棋盘，棋盘的每一个格子都为黑色或者白色，小易现在要用他喜欢的红色去涂画棋盘。小易会找出棋盘中某一列中拥有相同颜色的最大的区域去涂画，帮助小易算算他会涂画多少个棋格。 </p>
</blockquote>
<p>原题地址在这里：<a href="https://www.nowcoder.com/question/next?pid=4575457&amp;qid=83061&amp;tid=7519540" target="_blank" rel="external">牛客网</a></p>
<p>输入描述：</p>
<blockquote>
<ul>
<li>输入数据包括n+1行：</li>
<li>第一行为一个整数n(1 ≤ n ≤ 50),即棋盘的大小</li>
<li>接下来的n行每行一个字符串表示第i行棋盘的颜色，’W’表示白色，’B’表示黑色</li>
</ul>
</blockquote>
<p>输出描述：</p>
<blockquote>
<p>输出小易会涂画的区域大小</p>
</blockquote>
<p>输入例子：</p>
<blockquote>
<p>3<br>BWW<br>BBB<br>BWB</p>
</blockquote>
<p>输出例子</p>
<blockquote>
<p>3</p>
</blockquote>
<h4 id="用java编写，思路是这样的："><a href="#用java编写，思路是这样的：" class="headerlink" title="用java编写，思路是这样的："></a>用java编写，思路是这样的：</h4><p>1 使用<code>java.util.Scanner</code>接收控制台输入<br>2 定义两个变量<code>int iw,ib</code>和一个数组<code>int[] maxs</code>: </p>
<ul>
<li><code>iw</code>用于累加当前列 <strong>W</strong> 连续出现的次数</li>
<li><code>ib</code>用于累加当前列 <strong>B</strong> 连续出现的次数</li>
<li><code>maxs</code> 数组用于记录每一列出现的<em>拥有相同颜色的最大的区域</em>（即在一列中出现 连续的相同颜色的<em>单元格</em> 的最大个数）</li>
<li><strong>遍历（双层循环）保存了W/B的二维数组，在内层循环里判断当前 <em>单元格</em> 的值是 W 还是 B ，是 W 的话：</strong><ul>
<li><strong>先 让负责记录当前列中 W 连续出现次数的 iw 自增1</strong></li>
<li><strong>后 判断用于记录当前列出现 <em>“拥有相同颜色的最大的区域”</em> 的 maxs[i]的值是否小于此时的 iw ，是则把 iw 的值赋给他，否则不改变他的值 </strong></li>
<li><strong>最后 让负责记录当前列中 B 连续出现次数的 ib 置为0，因为此时遇到了 W ，即 B 不连续了，被 W 打断了</strong></li>
</ul>
</li>
<li><strong>遇到 B 也是同样的操作：ib 自增1，判断当前的 maxs[i] ，把 iw 置为0；</strong>    </li>
<li>注意在开始遍历每一列前（外层循环内）要把 iw , ib ,maxs[i]置为0；</li>
</ul>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"><span class="keyword">import</span> java.util.Scanner;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Scanner in = <span class="keyword">new</span> Scanner(System.in);</div><div class="line">        <span class="keyword">int</span> n = in.nextInt();</div><div class="line">        <span class="keyword">if</span> (!(n &gt;= <span class="number">1</span> &amp;&amp; n &lt;= <span class="number">50</span>))</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        in.nextLine();</div><div class="line">        <span class="keyword">char</span>[][] res = <span class="keyword">new</span> <span class="keyword">char</span>[n][n];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            String str = in.nextLine();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">                res[i][j] = str.charAt(j);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> iw = <span class="number">0</span>, ib = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span>[] maxs= <span class="keyword">new</span> <span class="keyword">int</span>[n];</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">            maxs[i] = <span class="number">0</span>;</div><div class="line">            iw = ib = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</div><div class="line">                <span class="keyword">if</span> (res[j][i] == <span class="string">'W'</span>) &#123;</div><div class="line">                    iw++;</div><div class="line">                    maxs[i] = iw &gt; maxs[i] ? iw : maxs[i];</div><div class="line">                    ib = <span class="number">0</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    ib++;</div><div class="line">                    maxs[i] = ib &gt; maxs[i] ? ib : maxs[i];</div><div class="line">                    iw = <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        Arrays.sort(maxs);</div><div class="line">        System.out.println(<span class="string">""</span>+maxs[maxs.length - <span class="number">1</span>]);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>提交运行</em> 之后就会提示通过所有测试用例：<br><img src="http://img.blog.csdn.net/20170327220859483?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYWltZWltZWlUUw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h4 id="注意点："><a href="#注意点：" class="headerlink" title="注意点："></a>注意点：</h4><ul>
<li>在使用 Scanner 接收控制台输入时先调用了 <code>int nextInt()</code> 方法，程序运行到该句时会阻塞，等待控制台输入并按回车，之后该方法就会返回输入的 int 值，别忘了此时还有一个  <em>回车符</em>  没有被解析，先要调用 <code>String nextLine()</code>把 <em>回车符</em>  消耗掉，否则在之后调用 <code>String nextLine()</code>获取输入的 W/B 时会出错。</li>
<li>调用<code>Arrays</code>类的<code>void sort(int[] a)</code>方法对 <code>maxs</code>数组进行排序（升序），输出<br><code>maxs[maxs.length - 1]</code>即为所求。</li>
</ul>
<center><u><b><em>END</em></b></u></center>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/26/Android-用WebView开发简单的浏览器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="James Duan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Duan">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/26/Android-用WebView开发简单的浏览器/" itemprop="url">Android：用WebView开发简单的浏览器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-26T21:22:11+08:00">
                2017-03-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Android-用WebView开发简单的浏览器"><a href="#Android-用WebView开发简单的浏览器" class="headerlink" title="Android-用WebView开发简单的浏览器"></a>Android-用WebView开发简单的浏览器</h3><p>Android 提供了 WebView 组件，WebView 本身就是一个浏览器实现。</p>
<h3 id="例子中主要用到了-WebView-的以下方法："><a href="#例子中主要用到了-WebView-的以下方法：" class="headerlink" title="例子中主要用到了 WebView 的以下方法："></a>例子中主要用到了 WebView 的以下方法：</h3><ul>
<li>void loadUrl(String url) 加载指定 url 对应的网页</li>
<li>void goBack() 后退</li>
<li>void goForward() 前进</li>
<li>boolean canGoBack() 根据<code>历史记录</code>判断是否可以回退</li>
<li>boolean canGoForward() 根据<code>历史记录</code>判断是否可以前进</li>
<li>WebSettings getSettings() 获得对 WebView 进行控制的 WebSettings 对象<br>（调用其<code>setJavaScriptEnabled</code>方法使<code>WebView</code>支持<code>JavaScript</code>）</li>
<li>void setWebViewClient(WebViewClient client) WebViewClient 负责处理<br>WebView 各种通知，请求，比如页面开始加载及加载完成、资源加载中、url已打开等</li>
<li>void setWebChromeClient(WebChromeClient client) WebChromeClient主要辅助WebView处理Javascript的对话框、网站图标、网站title、<strong>加载进度</strong>等</li>
</ul>
<h3 id="浏览器功能概述："><a href="#浏览器功能概述：" class="headerlink" title="浏览器功能概述："></a>浏览器功能概述：</h3><ol>
<li>第一次打开应用时默认会把<code>百度</code>设置为首页，可通过底部<code>主页</code>按钮跳转到主页，或通过长按弹出对话框修改主页</li>
<li><code>主页</code>的 URL 地址使用<code>SharedPreference</code>保存</li>
<li>底部四个<code>ImageButton</code>从做往右依次为<code>主页</code> <code>刷新</code> <code>回退</code> <code>前进</code></li>
<li>顶部的<code>ActionBar</code>用<code>void setCustomView(View)</code>添加了一个自定义的用于<code>输入网址</code>的输入框和一个<code>转到</code>按钮，<code>转到</code>按钮默认是不可见且不可用的，当点击了用于<code>输入网址</code>的<code>EditText</code>就会显示并可用。</li>
<li>用于显示网页加载进度的<code>ProgressBar</code></li>
</ol>
<h3 id="截图"><a href="#截图" class="headerlink" title="截图"></a>截图</h3><p><img src="http://img.blog.csdn.net/20170326211407503?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYWltZWltZWlUUw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>
<h3 id="代码部分"><a href="#代码部分" class="headerlink" title="代码部分"></a>代码部分</h3><ul>
<li>每次打开一个网页时会调用该方法，在这里控制<code>ActionBar</code>内的<code>Edittext</code>显示<code>加载中...</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> mWebView.setWebViewClient(<span class="keyword">new</span> WebViewClient() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageStarted</span><span class="params">(WebView view, String url, Bitmap favicon)</span> </span>&#123;</div><div class="line">                <span class="keyword">super</span>.onPageStarted(view, url, favicon);</div><div class="line">                mShowTitle.setText(<span class="string">"加载中..."</span>);</div><div class="line">            &#125;</div><div class="line">            ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>覆写<code>shouldOverrideUrlLoading</code>并返回<code>true</code>，否则 WebView 默认会调用系统的浏览器或第三方浏览器，而不使用当前activity中的<code>WebView</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mWebView.setWebViewClient(<span class="keyword">new</span> WebViewClient() &#123;</div><div class="line">			...</div><div class="line">			<span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> </span>&#123;</div><div class="line">                view.loadUrl(url);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">		    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>当网页加载进度改变时会回调<code>onProgressChanged</code>方法，在这里更新用于显示进度的<code>ProgressBar</code>。注意<code>newProgress</code>值为 0 到 100 ，因而将<code>ProgressBar</code>最大值设为 100 。</li>
<li><p><code>onReceivedTitle</code>返回当前加载网页的标题将标题显示在 actionBar 内的 EditText 上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">mWebView.setWebChromeClient(<span class="keyword">new</span> WebChromeClient() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onProgressChanged</span><span class="params">(WebView view, <span class="keyword">int</span> newProgress)</span> </span>&#123;</div><div class="line">                mProgressBar.setProgress(newProgress);</div><div class="line">                <span class="keyword">if</span> (newProgress == <span class="number">100</span>) &#123;</div><div class="line">                    mProgressBar.postDelayed(() -&gt; mProgressBar.setProgress(<span class="number">0</span>), <span class="number">2000</span>);</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceivedTitle</span><span class="params">(WebView view, String title)</span> </span>&#123;</div><div class="line">                <span class="keyword">super</span>.onReceivedTitle(view, title);</div><div class="line">                currentUrlTitle = title;</div><div class="line">                mShowTitle.setText(currentUrlTitle);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
</li>
<li><p>监听物理按键<code>返回</code>的点击事件，如果<code>WebView</code>的<code>历史记录</code>里有上一页相关记录就调用<code>void goBack()</code>方法</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mWebView.canGoBack())</div><div class="line">            mWebView.goBack();</div><div class="line">        <span class="keyword">else</span> finish();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li>判断当前是否处于正在输入网址（actionBar上的 EditText）的状态<br>1 是的话调用此方法表示输入结束从使<code>转到</code>按钮消失并不可用<br>2 使<code>EditText</code>控件失去焦点，不然会一直显示光标，效果不好</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finishEdit</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (isEditFocus) &#123;</div><div class="line">            isEditFocus = <span class="keyword">false</span>;</div><div class="line">            mShowTitle.clearFocus();</div><div class="line"></div><div class="line">            Animation animation = AnimationUtils.loadAnimation(MainActivity.<span class="keyword">this</span>, android.R.anim.fade_out);</div><div class="line">            animation.setFillAfter(<span class="keyword">true</span>);</div><div class="line">            mLoadUrl.startAnimation(animation);</div><div class="line">            mLoadUrl.setEnabled(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">            mShowTitle.setText(currentUrlTitle);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个方法有三个地方调用到：<br>1 当正在输入网址时用户转移注意力到<code>WebView</code>上，并触摸到<code>WebView</code>，此时会先判断软键盘是否正在显示，正在显示就关闭软键盘然后使输入框失去焦点并隐藏<code>转到</code>按钮</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mWebView.setOnTouchListener((View view, MotionEvent event) -&gt; &#123;</div><div class="line">      <span class="keyword">if</span> (event.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">          finishEdit();</div><div class="line">          InputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);</div><div class="line">          <span class="keyword">if</span> (imm.isActive())</div><div class="line">              imm.hideSoftInputFromWindow(mShowTitle.getWindowToken(),<span class="number">0</span>);</div><div class="line"></div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;);</div></pre></td></tr></table></figure>
<p>2 当<strong>正在输入</strong>网址时点击了物理按键<code>返回</code>,此时<code>void onBackPressed()</code>方法是不会被调用的，因为此时软键盘正在显示，调用<code>boolean dispatchKeyEvent(KeyEvent event)</code>方法拦截<code>返回</code>按键的点击事件，关闭软键盘的同时使输入框失去焦点并隐藏<code>转到</code>按钮。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchKeyEvent</span><span class="params">(KeyEvent event)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (event.getKeyCode() == KeyEvent.KEYCODE_BACK)</div><div class="line">            finishEdit();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.dispatchKeyEvent(event);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>3  点击了 actionBar 处的<code>转到</code>按钮<br>3.1 此时要先判断是否正确输入，然后判断输入网址是否是新的（和当前正在显示的网页的网址不同），满足就让<code>WebView</code>加载该网页<br>3.2 判断软键盘是否正在显示，正在显示就关闭软键盘然后使输入框失去焦点并隐藏<code>转到</code>按钮</p>
<blockquote>
<p>以下代码包含所有按钮的点击事件，每个按钮都在xml中添加了<br><code>android:onClick=&quot;onClick&quot;</code>属性</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">       <span class="keyword">switch</span> (view.getId()) &#123;</div><div class="line">           <span class="keyword">case</span> R.id.main_goBack:</div><div class="line">               <span class="keyword">if</span> (mWebView.canGoBack())</div><div class="line">                   mWebView.goBack();</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> R.id.main_goForward:</div><div class="line">               <span class="keyword">if</span> (mWebView.canGoForward())</div><div class="line">                   mWebView.goForward();</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> R.id.main_refresh:</div><div class="line">               mWebView.loadUrl(currentUrl);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> R.id.actionBar_goto:</div><div class="line">               String url = mShowTitle.getText().toString() == <span class="string">""</span> ? <span class="keyword">null</span> : mShowTitle.getText().toString().equals(currentUrl) ? <span class="keyword">null</span> : mShowTitle.getText().toString();</div><div class="line">               <span class="keyword">if</span> (url != <span class="keyword">null</span>)</div><div class="line">                   mWebView.loadUrl(url);</div><div class="line"></div><div class="line">               InputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);</div><div class="line">               <span class="keyword">if</span> (imm.isActive())</div><div class="line">                   imm.hideSoftInputFromWindow(mShowTitle.getWindowToken(),<span class="number">0</span>);</div><div class="line"></div><div class="line">               finishEdit();</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> R.id.main_home:</div><div class="line">               <span class="keyword">if</span> (!currentUrl.equals(homeUrl))</div><div class="line">                   mWebView.loadUrl(homeUrl);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="值得注意的地方："><a href="#值得注意的地方：" class="headerlink" title="值得注意的地方："></a>值得注意的地方：</h3><ul>
<li><p>在style中使用<code>colorControlHighlight</code>属性改变默认的按钮点击波纹效果的颜色<br>比如这样：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorControlHighlight"</span>&gt;</span>@color/colorPrimary<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>在按钮的xml属性中通过设置</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">style=`"@style/Base.Widget.AppCompat.Button.Borderless.Colored"</div></pre></td></tr></table></figure>
<p>使按钮的点击效果不受布局边界限制。其他默认不可点击的view（如EditText，TextView等）还要在添加一个：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">android:clickable="true"</div></pre></td></tr></table></figure>
<ul>
<li>使用到的图标在这里下载的：<a href="https://material.io/icons/" target="_blank" rel="external">Material icons - Material Design</a></li>
<li>调用<code>ActionBar</code>的<code>setCustomView</code>方法前先要调用<code>setDisplayShowCustomEnabled</code>方法并置为true。</li>
<li>修改主页用到了对话框：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">AlertDialog.Builder builder</div><div class="line"> .setTitle(<span class="string">"修改主页"</span>)</div><div class="line">    .setNegativeButton(<span class="string">"取消"</span>, (DialogInterface dialog, <span class="keyword">int</span> which) -&gt; dialog.dismiss())</div></pre></td></tr></table></figure>
<p>这里本来是用<code>new DialogInterface.OnClickListener() {...}</code>的形式写的，后来改成使用<code>Lambda</code>的方式，这时要在app的<code>build.gradle</code>里加上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">    ...</div><div class="line">        jackOptions &#123;</div><div class="line">            enabled true</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    compileOptions &#123;</div><div class="line">        targetCompatibility 1.8</div><div class="line">        sourceCompatibility 1.8</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<center><u><b><em>END</em></b></u></center>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="James Duan" />
          <p class="site-author-name" itemprop="name">James Duan</p>
           
              <p class="site-description motion-element" itemprop="description">just do it.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/DuanJiaNing" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://blog.csdn.net/aimeimeits" target="_blank" title="CSDN">
                  
                    <i class="fa fa-fw fa-csdn"></i>
                  
                  CSDN
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="aimeimeits@gmail.com" target="_blank" title="Gmail">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Gmail
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/CAFE_BABE_Duan" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="2217611834" target="_blank" title="QQ">
                  
                    <i class="fa fa-fw fa-qq"></i>
                  
                  QQ
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  Thu May 18 2017 08:00:00 GMT+0800 (中国标准时间) - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">James Duan</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
